<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIS Boats - Professional Quotation System V39</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Generation Libraries -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <style>
        :root {
            --navy: #0f2847; --navy-dark: #0a1628; --navy-light: #1a3a5c;
            --gold: #B83240; --gold-light: #d13d4c; --gold-dark: #A52A3A;
            --white: #ffffff; --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6;
            --gray-400: #ced4da; --gray-500: #adb5bd; --gray-600: #6c757d; --gray-700: #495057;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background: var(--gray-100); min-height: 100vh; }
        
        /* Header */
        .header { background: linear-gradient(135deg, var(--navy-dark), var(--navy)); padding: 20px 30px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .header-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo-area { display: flex; align-items: center; gap: 20px; }
        .logo-divider { width: 1px; height: 40px; background: linear-gradient(180deg, transparent, rgba(255,255,255,0.5), transparent); }
        .logo-text span { font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 2px; }
        .logo-text h1 { color: var(--white); font-size: 20px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .quote-badge { background: var(--gold); border: 1px solid var(--gold); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; }
        
        /* Progress */
        .progress-bar { background: var(--navy-dark); padding: 20px 30px; border-top: 1px solid rgba(255,255,255,0.1); position: sticky; top: 80px; z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .progress-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; position: relative; }
        .progress-inner::before { content: ''; position: absolute; top: 20px; left: 60px; right: 60px; height: 2px; background: rgba(255,255,255,0.2); }
        .step { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; z-index: 1; }
        .step-num { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-weight: 600; font-size: 14px; margin-bottom: 8px; transition: all 0.3s; }
        .step-label { font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        .step.active .step-num { background: var(--gold); border-color: var(--gold); color: white; box-shadow: 0 0 20px rgba(184,50,64,0.4); }
        .step.active .step-label { color: white; }
        .step.done .step-num { background: var(--success); border-color: var(--success); color: white; }
        .step.done .step-label { color: var(--success); }
        
        /* Main */
        .main { max-width: 1400px; margin: 0 auto; padding: 30px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Layout */
        .layout { display: grid; grid-template-columns: 1fr 350px; gap: 25px; }
        @media (max-width: 1100px) { .layout { grid-template-columns: 1fr; } }
        
        /* Cards */
        .card { background: var(--white); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, var(--navy), var(--navy-light)); padding: 18px 22px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { color: var(--white); font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .card-header h2::before { content: ''; width: 4px; height: 20px; background: var(--gold); border-radius: 2px; }
        .card-body { padding: 22px; }
        
        /* Boat Types */
        .boat-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        @media (max-width: 900px) { .boat-types { grid-template-columns: 1fr; } }
        .boat-type { background: var(--gray-100); border: 2px solid var(--gray-200); border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s; text-align: center; position: relative; overflow: hidden; }
        .boat-type::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gray-300); transition: all 0.3s; }
        .boat-type:hover { border-color: var(--navy); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .boat-type:hover::before { background: var(--navy); }
        .boat-type.selected { border-color: var(--gold); background: linear-gradient(135deg, #fef5f6, #fdeaec); }
        .boat-type.selected::before { background: var(--gold); }
        .boat-type-icon { width: 80px; height: 80px; margin: 0 auto 15px; background: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .boat-type h3 { font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
        .boat-type p { font-size: 13px; color: var(--gray-600); margin-bottom: 15px; }
        .boat-type-stats { display: flex; justify-content: center; gap: 25px; padding-top: 15px; border-top: 1px solid var(--gray-300); }
        .stat { text-align: center; }
        .stat-val { font-size: 16px; font-weight: 700; color: var(--navy); }
        .stat-label { font-size: 10px; color: var(--gray-500); text-transform: uppercase; }
        
        /* Boat Sizes */
        .boat-sizes { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        .boat-size { background: var(--gray-100); border: 2px solid var(--gray-200); border-radius: 10px; padding: 18px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .boat-size:hover { border-color: var(--navy); transform: translateY(-2px); }
        .boat-size.selected { border-color: var(--gold); background: linear-gradient(135deg, #fef5f6, #fdeaec); }
        .boat-size .size { font-size: 22px; font-weight: 700; color: var(--navy); }
        .boat-size .price { font-size: 15px; font-weight: 600; color: var(--gold-dark); margin: 6px 0; }
        .boat-size .specs { font-size: 11px; color: var(--gray-500); }
        
        /* Summary Sidebar */
        .summary { background: linear-gradient(135deg, var(--navy-dark), var(--navy)); border-radius: 12px; padding: 22px; color: var(--white); position: sticky; top: 200px; }
        .summary-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: white; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .summary-row .lbl { color: var(--gray-400); }
        .summary-row .val { font-weight: 600; }
        .summary-total { display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 2px solid var(--gold); font-size: 18px; font-weight: 700; }
        .summary-total .lbl { color: white; }
        .curr-btns { display: flex; gap: 5px; margin-top: 15px; }
        .rate-info { font-size: 11px; color: var(--gray-500); margin-top: 8px; text-align: center; }
        .curr-btn { flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--gray-400); border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.3s; }
        .curr-btn.active { background: var(--gold); border-color: var(--gold); color: white; }
        
        /* Categories */
        .category { background: var(--white); border: 1px solid var(--gray-200); border-radius: 10px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .cat-header { background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: var(--white); padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .cat-header:hover { background: linear-gradient(135deg, var(--navy-light), var(--navy)); }
        .cat-header h3 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; display: flex; align-items: center; }
        .cat-header .cat-total { background: var(--gold); color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .cat-header .arrow { font-size: 10px; margin-left: 10px; transition: transform 0.3s; }
        .cat-header.open .arrow { transform: rotate(180deg); }
        .cat-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .cat-content.open { max-height: 3000px; }
        
        /* Main Category Groups */
        .main-group { margin-bottom: 20px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .main-group-header { background: linear-gradient(135deg, #1a365d, #2d4a7c); color: var(--white); padding: 18px 22px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .main-group-header:hover { background: linear-gradient(135deg, #2d4a7c, #1a365d); }
        .main-group-header h2 { font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 0; display: flex; align-items: center; gap: 12px; }
        .main-group-header h2 .group-icon { font-size: 22px; }
        .main-group-header .group-total { background: var(--gold); color: white; padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; }
        .main-group-header .group-arrow { font-size: 14px; margin-left: 12px; transition: transform 0.3s; }
        .main-group-header.open .group-arrow { transform: rotate(180deg); }
        .main-group-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; background: #f0f4f8; }
        .main-group-content.open { max-height: 15000px; }
        .main-group-inner { padding: 15px; }
        .main-group-inner .category { margin-bottom: 10px; }
        
        /* Main group color variants */
        .main-group-engine .main-group-content, .main-group-engine .main-group-inner { background: #e6f4f8; }
        .main-group-engine .subgroup { background: #d4eef5; border-color: #a8dae8; }
        .main-group-engine .subgroup-header { background: #bde4f0; }
        .main-group-engine .subgroup-header:hover { background: #a8dae8; }
        .main-group-engine .subgroup-content { background: #e6f4f8; }
        
        .main-group-accessories .main-group-content, .main-group-accessories .main-group-inner { background: #fdf6e9; }
        .main-group-accessories .subgroup { background: #faecd4; border-color: #f0d9a8; }
        .main-group-accessories .subgroup-header { background: #f5e4c4; }
        .main-group-accessories .subgroup-header:hover { background: #f0d9a8; }
        .main-group-accessories .subgroup-content { background: #fdf6e9; }
        
        .main-group-electronics .main-group-content, .main-group-electronics .main-group-inner { background: #f3eefa; }
        .main-group-electronics .subgroup { background: #e8dcf5; border-color: #d4c4eb; }
        .main-group-electronics .subgroup-header { background: #ddd0f0; }
        .main-group-electronics .subgroup-header:hover { background: #d4c4eb; }
        .main-group-electronics .subgroup-content { background: #f3eefa; }
        
        /* Flat category (top-level like Propulsion) */
        .flat-category { margin-bottom: 20px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .flat-category .cat-header { background: linear-gradient(135deg, #1a365d, #2d4a7c); padding: 18px 22px; }
        .flat-category .cat-header h3 { font-size: 16px; font-weight: 700; letter-spacing: 1px; }
        .flat-category .cat-total { padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; }
        .flat-category.engine-flat .cat-content { background: #e6f4f8; }
        .flat-category.accessories-flat .cat-content { background: #fdf6e9; }
        .flat-category.electronics-flat .cat-content { background: #f3eefa; }
        
        /* Nested subgroup (e.g., Seating within ASIS Accessories) */
        .subgroup { margin-bottom: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #d1dce8; background: #e8eef4; }
        .subgroup-header { background: #dbe4ed; color: #2d3748; padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .subgroup-header:hover { background: #cdd8e6; }
        .subgroup-header h4 { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }
        .subgroup-header .subgroup-total { background: var(--gold); color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .subgroup-header .subgroup-arrow { font-size: 10px; margin-left: 10px; transition: transform 0.3s; }
        .subgroup-header.open .subgroup-arrow { transform: rotate(180deg); }
        .subgroup-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; background: #f5f7fa; }
        .subgroup-content.open { max-height: 5000px; }
        .subgroup-inner { padding: 10px; }
        .subgroup-inner .category { margin-bottom: 8px; }
        
        .cat-inner { padding: 15px; }
        
        /* Item Grid */
        .item-grid-header { display: grid; grid-template-columns: 2fr 70px 110px 100px 40px; gap: 10px; padding: 10px 12px; background: var(--gray-100); border-radius: 6px; margin-bottom: 10px; }
        .item-grid-header span { font-size: 10px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; }
        .item-grid-header .right { text-align: right; }
        
        .item-row { display: grid; grid-template-columns: 2fr 70px 110px 100px 40px; gap: 10px; padding: 12px; border-bottom: 1px solid var(--gray-200); align-items: center; transition: background 0.2s; }
        .item-row:hover { background: var(--gray-100); }
        .item-row:last-of-type { border-bottom: none; }
        .item-row select { width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px; background: var(--white); cursor: pointer; }
        .item-row select:focus { outline: none; border-color: var(--gold); }
        .item-row input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; text-align: center; font-size: 13px; font-weight: 500; }
        .item-row .price-input { text-align: right; font-weight: 600; color: var(--gray-700); }
        .item-row .extended { font-weight: 700; color: var(--success); text-align: right; font-size: 14px; }
        .item-row .tbd { color: var(--warning); font-style: italic; }
        .delete-btn { width: 36px; height: 36px; border: none; background: var(--danger); color: var(--white); border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .delete-btn:hover { background: #c82333; transform: scale(1.05); }
        .add-btn { background: var(--success); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; margin-top: 12px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .add-btn:hover { background: #218838; transform: translateY(-1px); }
        
        .custom-input { width: 100%; padding: 10px; border: 2px dashed var(--gold); border-radius: 6px; font-size: 13px; background: #fef5f6; }
        .custom-input:focus { outline: none; border-style: solid; }
        
        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: span 2; }
        .form-group label { font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px 14px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); }
        
        /* Buttons */
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: white; box-shadow: 0 4px 15px rgba(184,50,64,0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(184,50,64,0.4); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-success { background: linear-gradient(135deg, var(--success), #1e7e34); color: var(--white); }
        .btn-outline { background: linear-gradient(135deg, #4a5568, #718096); color: var(--white); border: none; }
        .btn-outline:hover { background: linear-gradient(135deg, #2d3748, #4a5568); color: var(--white); }
        .actions { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--gray-200); }
        
        /* Preview */
        .preview { background: var(--white); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .preview-header { background: var(--navy); color: var(--white); padding: 40px; text-align: center; }
        .preview-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .preview-header p { color: white; font-size: 14px; letter-spacing: 2px; }
        .preview-body { padding: 40px; }
        .preview-meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 30px; padding-bottom: 30px; border-bottom: 2px solid var(--gray-200); }
        .preview-meta h4 { color: var(--navy); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .preview-meta p { font-size: 14px; color: var(--gray-700); line-height: 1.8; }
        .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .preview-table th { background: var(--navy); color: var(--white); padding: 14px; text-align: left; font-size: 12px; text-transform: uppercase; }
        .preview-table th.right { text-align: right; }
        .preview-table td { padding: 14px; border-bottom: 1px solid var(--gray-200); font-size: 14px; }
        .preview-table td.right { text-align: right; }
        .preview-totals { text-align: right; }
        .preview-totals div { padding: 8px 0; font-size: 15px; }
        .preview-totals .grand { font-size: 20px; font-weight: 700; color: var(--navy); border-top: 2px solid var(--navy); padding-top: 15px; margin-top: 10px; }
        .preview-notes { margin-top: 30px; padding: 20px; background: var(--gray-100); border-radius: 8px; border-left: 4px solid var(--gold); }
        .preview-notes h4 { color: var(--navy); font-size: 12px; text-transform: uppercase; margin-bottom: 10px; }
        .preview-notes p { font-size: 14px; color: var(--gray-700); white-space: pre-wrap; }

        /* Selected Items */
        .selected-items { max-height: 300px; overflow-y: auto; }
        .sel-item { display: flex; justify-content: space-between; padding: 6px 0; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .sel-item .name { color: var(--gray-300); max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sel-item .amt { color: var(--gold-light); font-weight: 600; }

        /* Info banner */
        .info-banner { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 1px solid #90caf9; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .info-banner .icon { font-size: 24px; }
        .info-banner .text { font-size: 13px; color: #1565c0; }
        .info-banner .text strong { display: block; margin-bottom: 3px; }

        /* Radio Button Groups (Exclusive Categories) */
        .radio-group { padding: 15px; }
        .radio-group-label { font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .radio-group-label .exclusive-badge { background: var(--gold); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; }
        .radio-option { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 8px; background: var(--gray-100); border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .radio-option:hover { border-color: var(--navy); background: var(--white); }
        .radio-option.selected { border-color: var(--gold); background: linear-gradient(135deg, #fef5f6, #fdeaec); }
        .radio-option input[type="radio"] { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--gold); cursor: pointer; }
        .radio-option .option-details { flex: 1; }
        .radio-option .option-name { font-size: 13px; font-weight: 500; color: var(--navy); }
        .radio-option .option-price { font-size: 14px; font-weight: 700; color: var(--gold-dark); margin-left: auto; }
        .radio-option .option-price.tbd { color: var(--warning); font-style: italic; }
        .radio-option.none-option { background: var(--white); border-style: dashed; }
        .radio-option.none-option .option-name { color: var(--gray-500); font-style: italic; }

        /* Checkbox Groups (Multi-select Categories) */
        .checkbox-group { padding: 15px; }
        .checkbox-option { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 8px; background: var(--gray-100); border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .checkbox-option:hover { border-color: var(--navy); background: var(--white); }
        .checkbox-option.selected { border-color: var(--success); background: linear-gradient(135deg, #f0fff4, #e6ffed); }
        .checkbox-option input[type="checkbox"] { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--success); cursor: pointer; flex-shrink: 0; }
        .checkbox-option .option-details { flex: 1; min-width: 0; }
        .checkbox-option .option-name { font-size: 13px; font-weight: 500; color: var(--navy); }
        .checkbox-option .option-price { font-size: 13px; font-weight: 600; color: var(--gold-dark); min-width: 80px; text-align: right; }
        .checkbox-option .option-price.tbd { color: var(--warning); font-style: italic; }
        .checkbox-option .qty-control { margin: 0 15px; }
        .checkbox-option .qty-control input { width: 55px; padding: 6px 8px; border: 1px solid var(--gray-300); border-radius: 4px; text-align: center; font-size: 13px; font-weight: 500; }
        .checkbox-option .qty-control input:focus { outline: none; border-color: var(--gold); }
        .checkbox-option .option-extended { font-size: 14px; font-weight: 700; color: var(--success); min-width: 90px; text-align: right; }
        .checkbox-option .option-extended .tbd { color: var(--warning); font-style: italic; font-weight: 500; }
        
        /* TBD Price Input */
        .tbd-price-input { width: 80px; padding: 4px 8px; border: 2px solid var(--warning); border-radius: 4px; font-size: 12px; font-weight: 600; text-align: right; background: #fffbeb; color: var(--navy-dark); }
        .tbd-price-input:focus { outline: none; border-color: var(--gold); background: #fff; }
        .tbd-price-input::placeholder { color: #b45309; font-style: italic; }
        .tbd-input-wrapper { display: flex; align-items: center; gap: 4px; }
        .tbd-input-wrapper span { color: var(--warning); font-weight: 600; }
        
        /* Custom Item Input */
        .custom-item-row { display: flex; gap: 8px; padding: 10px 12px; background: #f0fdf4; border-top: 1px dashed #86efac; margin-top: 5px; border-radius: 0 0 8px 8px; align-items: center; }
        .custom-item-row input[type="text"] { flex: 1; padding: 8px 12px; border: 1px solid #86efac; border-radius: 4px; font-size: 13px; }
        .custom-item-row input[type="text"]:focus { outline: none; border-color: var(--success); }
        .custom-item-row input[type="number"] { width: 70px; padding: 8px; border: 1px solid #86efac; border-radius: 4px; font-size: 13px; text-align: center; }
        .custom-item-row input[type="number"]:focus { outline: none; border-color: var(--success); }
        .custom-item-row .add-btn { background: var(--success); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; }
        .custom-item-row .add-btn:hover { background: #15803d; }
        .custom-item-row .price-input { width: 90px; }
        .custom-item-label { font-size: 11px; color: #16a34a; font-weight: 600; margin-right: 5px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <div class="logo-area">
                <div class="logo-text">
                    <span>Advanced Maritime Solutions</span>
                    <h1>ASIS BOATS</h1>
                </div>
            </div>
            <div class="header-right">
                <div class="quote-badge" id="quoteBadge">ASIS-25-0001</div>
            </div>
        </div>
    </header>

    <nav class="progress-bar">
        <div class="progress-inner">
            <div class="step active" onclick="goTo(1)"><div class="step-num">1</div><div class="step-label">Boat Selection</div></div>
            <div class="step" onclick="goTo(2)"><div class="step-num">2</div><div class="step-label">Configuration</div></div>
            <div class="step" onclick="goTo(3)"><div class="step-num">3</div><div class="step-label">Information</div></div>
            <div class="step" onclick="goTo(4)"><div class="step-num">4</div><div class="step-label">Review</div></div>
        </div>
    </nav>

    <main class="main">
        <!-- PAGE 1: BOAT SELECTION -->
        <div id="page1" class="page active">
            <div class="layout">
                <div>
                    <div class="card">
                        <div class="card-header"><h2>Select Boat Type</h2></div>
                        <div class="card-body">
                            <div class="boat-types" id="boatTypesGrid"></div>
                        </div>
                    </div>
                    <div class="card" id="sizesCard" style="display:none;">
                        <div class="card-header"><h2>Select Size</h2></div>
                        <div class="card-body">
                            <div class="boat-sizes" id="boatSizesGrid"></div>
                        </div>
                    </div>
                    <div class="actions">
                        <div></div>
                        <button class="btn btn-primary" onclick="goTo(2)" id="nextBtn1" disabled>Continue to Configuration ‚Üí</button>
                    </div>
                </div>
                <aside>
                    <div class="summary">
                        <div class="summary-title">Quote Summary</div>
                        <div class="summary-row"><span class="lbl">Boat Type</span><span class="val" id="sumType">-</span></div>
                        <div class="summary-row"><span class="lbl">Size</span><span class="val" id="sumSize">-</span></div>
                        <div class="summary-row"><span class="lbl">Base Price</span><span class="val" id="sumBase">-</span></div>
                        <div class="summary-row"><span class="lbl">Options & Accessories</span><span class="val" id="sumOptions">$0</span></div>
                        <div class="summary-total"><span class="lbl">Total</span><span class="val" id="sumTotal">$0</span></div>
                        <div class="curr-btns">
                            <button class="curr-btn active" onclick="setCurrency('USD')">USD</button>
                            <button class="curr-btn" onclick="setCurrency('AED')">AED</button>
                            <button class="curr-btn" onclick="setCurrency('EUR')">EUR</button>
                        </div>
                        <div id="rateInfo1" class="rate-info"></div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- PAGE 2: CONFIGURATION -->
        <div id="page2" class="page">
            <div class="layout">
                <div>
                    <div style="display:flex;gap:10px;align-items:stretch;margin-bottom:15px;">
                        <div class="info-banner" style="flex:1;margin-bottom:0;">
                            <span class="icon">‚ÑπÔ∏è</span>
                            <div class="text">
                                <strong>Accessories shown are specific to your selected boat type and size.</strong>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="padding:8px 16px;font-size:11px;white-space:nowrap;" onclick="toggleAllCategories()" id="toggleAllBtn">
                            ‚ñ≤ Collapse All
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2>Configure Your Boat</h2>
                            <span style="color:white;font-size:12px;font-weight:600;" id="selectedBoatLabel">-</span>
                        </div>
                        <div class="card-body" style="padding:0;">
                            <div id="categoriesContainer"></div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="goTo(1)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="goTo(3)">Continue to Information ‚Üí</button>
                    </div>
                </div>
                <aside>
                    <div class="summary">
                        <div class="summary-title">Selected Items</div>
                        <div class="selected-items" id="selectedItemsList"></div>
                        <div class="summary-total"><span class="lbl">Total</span><span class="val" id="sumTotal2">$0</span></div>
                        <div class="curr-btns">
                            <button class="curr-btn active" onclick="setCurrency('USD')">USD</button>
                            <button class="curr-btn" onclick="setCurrency('AED')">AED</button>
                            <button class="curr-btn" onclick="setCurrency('EUR')">EUR</button>
                        </div>
                        <div id="rateInfo2" class="rate-info"></div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- PAGE 3: INFORMATION -->
        <div id="page3" class="page">
            <div class="layout">
                <div>
                    <div class="card">
                        <div class="card-header"><h2>Quote Information</h2></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group" style="grid-column: span 2;"><label>Quotation Title</label><input type="text" id="quoteTitle" placeholder="e.g., 12m Aluminum RIB Boats" autocomplete="off"></div>
                                <div class="form-group"><label>Quote Number</label><input type="text" id="quoteNum" value="ASIS-25-0001" onchange="document.getElementById('quoteBadge').textContent=this.value" autocomplete="off"></div>
                                <div class="form-group"><label>Boat Quantity</label><input type="number" id="boatQty" value="1" min="1" max="100" onchange="updateTotals()"></div>
                                <div class="form-group"><label>Date</label><input type="date" id="quoteDate"></div>
                                <div class="form-group"><label>Validity</label><select id="validity"><option selected>30 Days</option><option>90 Days</option></select></div>
                                <div class="form-group"><label>Salesman</label><select id="salesman"><option value="">-- Select Salesman --</option><option value="mario">Mario Hoyek</option><option value="soufiane">Soufiane Tangi</option><option value="toji">Toji Paul</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Customer Information</h2></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group"><label>Company / Organization</label><input type="text" id="custCompany" placeholder="Company name"></div>
                                <div class="form-group"><label>Contact Person</label><input type="text" id="custName" placeholder="Full name"></div>
                                <div class="form-group"><label>Email</label><input type="email" id="custEmail" placeholder="email@company.com"></div>
                                <div class="form-group"><label>Phone</label><input type="tel" id="custPhone" placeholder="+971 XX XXX XXXX"></div>
                                <div class="form-group"><label>Tender Number <span style="font-weight:400;color:var(--gray-500);">(Optional)</span></label><input type="text" id="tenderNum" placeholder="Tender/RFQ number"></div>
                                <div class="form-group"><label>Address / Country</label><textarea id="custAddr" rows="2" placeholder="Address or country"></textarea></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Terms & Conditions</h2></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group"><label>Payment Terms</label><select id="payTerms"><option>50% Deposit, 50% on Delivery</option><option>30% / 70%</option><option>100% on Order</option></select></div>
                                <div class="form-group"><label>Delivery Terms</label><input type="text" id="deliveryTerms" value="Ex Factory" placeholder="Ex Factory, FOB, CIF, etc."></div>
                                <div class="form-group">
                                    <label>Delivery Timeline</label>
                                    <select id="deliverySelect" onchange="toggleDeliveryInput()">
                                        <option value="TBD" selected>TBD</option>
                                        <option value="60-90 Days">60-90 Days</option>
                                        <option value="90-120 Days">90-120 Days</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <input type="text" id="deliveryCustom" placeholder="Enter custom timeline" style="display:none;margin-top:8px;">
                                </div>
                                <div class="form-group"><label>Discount %</label><input type="number" id="discount" value="0" min="0" max="100" onchange="updateTotals()"></div>
                                <div class="form-group" style="display:flex;align-items:center;gap:10px;padding-top:20px;">
                                    <input type="checkbox" id="hideSubPrices" checked style="width:18px;height:18px;cursor:pointer;">
                                    <label for="hideSubPrices" style="margin:0;cursor:pointer;font-weight:normal;">Hide individual prices (show only total)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Notes</h2></div>
                        <div class="card-body">
                            <div class="form-group full">
                                <textarea id="quoteNotes" rows="4" placeholder="Additional notes, special requirements, or comments for this quotation..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="goTo(2)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="goTo(4)">Preview Quotation ‚Üí</button>
                    </div>
                </div>
                <aside>
                    <div class="summary">
                        <div class="summary-title">Order Summary</div>
                        <div class="summary-row"><span class="lbl">Subtotal</span><span class="val" id="sumSub3">$0</span></div>
                        <div class="summary-row"><span class="lbl">Discount</span><span class="val" id="sumDisc3">-$0</span></div>
                        <div class="summary-total"><span class="lbl">Grand Total</span><span class="val" id="sumTotal3">$0</span></div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- PAGE 4: REVIEW & EXPORT -->
        <div id="page4" class="page">
            <div class="card" style="margin-bottom:20px;">
                <div class="card-header">
                    <h2>Quotation Preview</h2>
                    <div style="display:flex;gap:10px;">
                        <button class="btn btn-success" onclick="downloadPDF()">üìÑ Download PDF</button>
                        <button class="btn btn-outline" onclick="downloadCSV()">üìä Export CSV</button>
                        <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Print</button>
                    </div>
                </div>
            </div>
            <div class="preview" id="previewArea">
                <div class="preview-header">
                    <h1>ASIS BOATS LLC</h1>
                    <p>PROFESSIONAL QUOTATION</p>
                    <p id="prevQuoteTitle" style="font-size:18px;margin-top:10px;color:var(--white);font-weight:600;"></p>
                </div>
                <div class="preview-body">
                    <div class="preview-meta">
                        <div><h4>Quotation Details</h4><p id="prevQuoteInfo"></p></div>
                        <div><h4>Customer</h4><p id="prevCustInfo"></p></div>
                    </div>
                    <table class="preview-table">
                        <thead><tr><th>Description</th><th>Qty</th><th class="right">Unit Price</th><th class="right">Total</th></tr></thead>
                        <tbody id="prevItems"></tbody>
                    </table>
                    <div class="preview-totals" id="prevTotals"></div>
                    <div class="preview-notes" id="prevNotes" style="display:none;"><h4>Notes</h4><p id="prevNotesText"></p></div>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-secondary" onclick="goTo(3)">‚Üê Edit</button>
                <button class="btn btn-primary" onclick="downloadPDF()">Generate & Download PDF</button>
            </div>
        </div>
    </main>

<script>
// ==================== DATA FROM EXCEL ====================
const BOATS = {
    aluminum: {
        name: 'Aluminium Boats', 
        desc: 'Professional-grade aluminum hull RHIBs', 
        icon: 'üö§',
        sizes: [
            {size:'6.5M', price:103090, fuel:'150L', pax:8},
            {size:'7.6M', price:120030, fuel:'450L', pax:10},
            {size:'8.5M', price:149800, fuel:'600L', pax:12},
            {size:'9.5M', price:180765, fuel:'600L', pax:14},
            {size:'11.5M', price:246770, fuel:'1200L', pax:18},
            {size:'13M', price:289475, fuel:'1100L', pax:20}
        ]
    },
    fiberglass: {
        name: 'Fiberglass Boats (GRP)', 
        desc: 'Versatile GRP construction RHIBs', 
        icon: '‚õµ',
        sizes: [
            {size:'4.1M', price:22900, fuel:'N/A', pax:4},
            {size:'5.1M', price:33560, fuel:'90L', pax:6},
            {size:'5.5M', price:35000, fuel:'90L', pax:6},
            {size:'6.5M', price:53040, fuel:'225L', pax:8},
            {size:'7.2M', price:56850, fuel:'225L', pax:10},
            {size:'8.0M', price:66560, fuel:'225L', pax:12},
            {size:'8.5M', price:83200, fuel:'225L', pax:14},
            {size:'9.5M', price:130080, fuel:'2x350L', pax:16},
            {size:'12M', price:160960, fuel:'2x300L', pax:20}
        ]
    },
    inflatable: {
        name: 'Inflatable Boats (HDIB)', 
        desc: 'Heavy Duty Inflatable Boats', 
        icon: 'üõü',
        sizes: [
            {size:'2.8M', price:8300, fuel:'N/A', pax:3},
            {size:'3.2M', price:9800, fuel:'N/A', pax:4},
            {size:'3.5M', price:10800, fuel:'N/A', pax:5},
            {size:'4.2M', price:12600, fuel:'N/A', pax:6},
            {size:'4.8M', price:15700, fuel:'N/A', pax:7},
            {size:'5.1M', price:16900, fuel:'N/A', pax:8}
        ]
    }
};

// Accessories by boat type - from Excel price list
// Each item has prices object keyed by size, with values: number, "X" (unavailable), "TBD", or "Incl."
// Define which categories are EXCLUSIVE (radio buttons - only one selection allowed)
const EXCLUSIVE_CATEGORIES = [
    "Propulsion / Engine",
    "Cabin / T-Top",
    "Leaning Posts",
    "A-Frame",
    "Life Jackets",
    "Trailers",
    "GPS",
    "Radar",
    "VHF",
    "FLIR / Thermal"
];

const ACCESSORIES = {
    aluminum: {
        "Propulsion / Engine": [
            {name: "Single Mercury F150Hp EXLPT (incl. controls, steering, gauges)", prices: {"6.5M":18620,"7.6M":"X","8.5M":"X","9.5M":"X","11.5M":"X","13M":"X"}},
            {name: "Twin Mercury F150Hp XLPT/CXLPT (incl. controls, steering, gauges)", prices: {"6.5M":"X","7.6M":34255,"8.5M":"X","9.5M":"X","11.5M":"X","13M":"X"}},
            {name: "Twin Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 502)", prices: {"6.5M":"X","7.6M":"X","8.5M":68975,"9.5M":68975,"11.5M":68975,"13M":"X"}},
            {name: "Twin Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":103120,"11.5M":103120,"13M":103120}},
            {name: "Triple Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 702)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":"X","13M":114950}},
            {name: "Triple Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":"X","13M":166180}}
        ],
        "General": [
            {name: "Boat Painting", prices: {"6.5M":17000,"7.6M":20000,"8.5M":22000,"9.5M":25500,"11.5M":30000,"13M":32000}},
            {name: "Custom Color Hypalon", prices: {"6.5M":2500,"7.6M":3000,"8.5M":3500,"9.5M":4000,"11.5M":4500,"13M":5000}},
            {name: "Double Layer Hypalon", prices: {"6.5M":15340,"7.6M":17500,"8.5M":20000,"9.5M":22420,"11.5M":27000,"13M":28320}},
            {name: "Hypalon Strip Between Fender", prices: {"6.5M":5000,"7.6M":6000,"8.5M":6880,"9.5M":7700,"11.5M":9300,"13M":9720}},
            {name: "Hypalon Branding And Numbering", prices: {"6.5M":700,"7.6M":800,"8.5M":900,"9.5M":1000,"11.5M":1100,"13M":1100}},
            {name: "Extra Handle", prices: {"6.5M":250,"7.6M":250,"8.5M":250,"9.5M":250,"11.5M":250,"13M":250}},
            {name: "Diver-Notch", prices: {"6.5M":9800,"7.6M":9800,"8.5M":9800,"9.5M":9800,"11.5M":9800,"13M":9800}},
            {name: "Notch Filling Inserts", prices: {"6.5M":2500,"7.6M":2500,"8.5M":2500,"9.5M":2500,"11.5M":3500,"13M":3500}},
            {name: "Bow Step with 2 Stainless Steel Cleats", prices: {"6.5M":545,"7.6M":545,"8.5M":545,"9.5M":545,"11.5M":545,"13M":545}},
            {name: "Aluminium Anchor with S.S Chain", prices: {"6.5M":1075,"7.6M":1075,"8.5M":1075,"9.5M":1075,"11.5M":1075,"13M":1075}},
            {name: "Aluminium Anchor with Rope 30m", prices: {"6.5M":390,"7.6M":390,"8.5M":390,"9.5M":390,"11.5M":390,"13M":390}},
            {name: "Windless Clipper with S.S Chain & Anchor", prices: {"6.5M":5360,"7.6M":5360,"8.5M":5360,"9.5M":5360,"11.5M":5360,"13M":5360}},
            {name: "Boat Cover", prices: {"6.5M":2500,"7.6M":4000,"8.5M":4500,"9.5M":5000,"11.5M":5500,"13M":5500}}
        ],
        "Console": [
            {name: "Aluminium Console with Windscreen and Grab Rail", prices: {"6.5M":10115,"7.6M":10115,"8.5M":10500,"9.5M":11200,"11.5M":12000,"13M":12000}}
        ],
        "Cabin / T-Top": [
            {name: "Aluminum Cabin with Cuddy and Toilet", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":79570,"11.5M":79570,"13M":79570}},
            {name: "Aluminum Cabin for 4 Pax", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"TBD","11.5M":"TBD","13M":"TBD"}},
            {name: "Aluminum Wheel-house", prices: {"6.5M":19115,"7.6M":19115,"8.5M":21000,"9.5M":21000,"11.5M":24000,"13M":24000}},
            {name: "Aluminium T-Top with Hard Top 1 (2.7m)", prices: {"6.5M":12560,"7.6M":12560,"8.5M":12560,"9.5M":12560,"11.5M":12560,"13M":12560}},
            {name: "Aluminium T-Top with Hard Top 2 (3.8m)", prices: {"6.5M":14920,"7.6M":14920,"8.5M":14920,"9.5M":14920,"11.5M":14920,"13M":14920}},
            {name: "Aluminium T-Top with Hard Top 3 (4.4m)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":32000,"13M":32000}}
        ],
        "Leaning Posts": [
            {name: "Aluminium Leaning Post Single", prices: {"6.5M":2765,"7.6M":2765,"8.5M":2765,"9.5M":2765,"11.5M":2765,"13M":2765}},
            {name: "Aluminium Leaning Post with Back Rest Single", prices: {"6.5M":3310,"7.6M":3310,"8.5M":3310,"9.5M":3310,"11.5M":3310,"13M":3310}},
            {name: "Aluminium Leaning Post Double", prices: {"6.5M":3400,"7.6M":3400,"8.5M":3400,"9.5M":3400,"11.5M":3400,"13M":3400}},
            {name: "Aluminium Leaning Post with Back Rest Double", prices: {"6.5M":4000,"7.6M":4000,"8.5M":4000,"9.5M":4000,"11.5M":4000,"13M":4000}}
        ],
        "Jockey & Grab Rail": [
            {name: "Grab Rail for Front Seat", prices: {"6.5M":650,"7.6M":650,"8.5M":650,"9.5M":650,"11.5M":650,"13M":650}},
            {name: "Single Aluminium Jockey Seat with Grab Rail", prices: {"6.5M":1270,"7.6M":1270,"8.5M":1270,"9.5M":1270,"11.5M":1270,"13M":1270}},
            {name: "Double Aluminium Jockey Seat with Grab Rail", prices: {"6.5M":2535,"7.6M":2535,"8.5M":2535,"9.5M":2535,"11.5M":2535,"13M":2535}}
        ],
        "Suspension Seats": [
            {name: "Ullman BISCAYA Jockey Suspension Seat", prices: {"6.5M":5500,"7.6M":5500,"8.5M":5500,"9.5M":5500,"11.5M":5500,"13M":5500}},
            {name: "Ullman Patrol Jockey Suspension Seat", prices: {"6.5M":6250,"7.6M":6250,"8.5M":6250,"9.5M":6250,"11.5M":6250,"13M":6250}},
            {name: "Echelon Midback Jockey Suspension Seat", prices: {"6.5M":16300,"7.6M":16300,"8.5M":16300,"9.5M":16300,"11.5M":16300,"13M":16300}}
        ],
        "A-Frame": [
            {name: "Aluminium A Frame", prices: {"6.5M":2885,"7.6M":2885,"8.5M":2885,"9.5M":2885,"11.5M":3260,"13M":3260}},
            {name: "Aluminium A Frame With Self-righting System", prices: {"6.5M":9730,"7.6M":9730,"8.5M":9730,"9.5M":9730,"11.5M":10140,"13M":10140}},
            {name: "Aluminium A Frame with Ladder", prices: {"6.5M":4300,"7.6M":4300,"8.5M":4300,"9.5M":4300,"11.5M":4675,"13M":4675}}
        ],
        "Other Frames & Structure": [
            {name: "Aluminium Tube Ladder", prices: {"6.5M":2500,"7.6M":2500,"8.5M":2500,"9.5M":2500,"11.5M":2500,"13M":2500}},
            {name: "Swim Platform at Transom for Inboard Engine", prices: {"6.5M":1285,"7.6M":1285,"8.5M":1285,"9.5M":1285,"11.5M":1285,"13M":1285}},
            {name: "Aluminium Bow Tow Post", prices: {"6.5M":2230,"7.6M":2230,"8.5M":2230,"9.5M":2230,"11.5M":2230,"13M":2230}},
            {name: "Aluminium Aft Tow Post", prices: {"6.5M":2230,"7.6M":2230,"8.5M":2230,"9.5M":2230,"11.5M":2230,"13M":2230}},
            {name: "Aluminium Bollard", prices: {"6.5M":835,"7.6M":835,"8.5M":835,"9.5M":835,"11.5M":835,"13M":835}},
            {name: "Bow HD Tow Post w/Weapons Mount Flange", prices: {"6.5M":7000,"7.6M":7000,"8.5M":7000,"9.5M":7000,"11.5M":7000,"13M":7000}},
            {name: "Aft HD Tow Post w/Weapons Mount Flange", prices: {"6.5M":7000,"7.6M":7000,"8.5M":7000,"9.5M":7000,"11.5M":7000,"13M":7000}}
        ],
        "Life Jackets": [
            {name: "Life Jacket SOLAS Foam with Flashlight 170N", prices: {"6.5M":85,"7.6M":85,"8.5M":85,"9.5M":85,"11.5M":85,"13M":85}},
            {name: "Life Jacket Manual Inflatable 170N", prices: {"6.5M":120,"7.6M":120,"8.5M":120,"9.5M":120,"11.5M":120,"13M":120}}
        ],
        "Other Safety": [
            {name: "Distress Signal Kit for Coastal Navigation", prices: {"6.5M":200,"7.6M":200,"8.5M":200,"9.5M":200,"11.5M":200,"13M":200}},
            {name: "2x Fire Extinguisher (2Kg) IAW COLREGS", prices: {"6.5M":300,"7.6M":300,"8.5M":300,"9.5M":300,"11.5M":300,"13M":300}},
            {name: "2x 20\" USCG Approved Ring Buoy IAW COLREGS", prices: {"6.5M":160,"7.6M":160,"8.5M":160,"9.5M":160,"11.5M":160,"13M":160}},
            {name: "2x Mooring Rope 12mm 20m", prices: {"6.5M":300,"7.6M":300,"8.5M":300,"9.5M":300,"11.5M":300,"13M":300}},
            {name: "2x Gunwale Mounted Boat Hook", prices: {"6.5M":150,"7.6M":150,"8.5M":150,"9.5M":150,"11.5M":150,"13M":150}},
            {name: "Forward Deck Mounted Boarding Team Hand Railing", prices: {"6.5M":5200,"7.6M":5200,"8.5M":5200,"9.5M":5200,"11.5M":5200,"13M":5200}},
            {name: "Single Hoisting Lifting System", prices: {"6.5M":19500,"7.6M":19500,"8.5M":19500,"9.5M":19500,"11.5M":19500,"13M":19500}},
            {name: "Fire Extinguisher Compartment", prices: {"6.5M":310,"7.6M":310,"8.5M":310,"9.5M":310,"11.5M":310,"13M":310}},
            {name: "Anti-fouling Hull Bottom Paint", prices: {"6.5M":2575,"7.6M":3140,"8.5M":3460,"9.5M":3750,"11.5M":4275,"13M":4500}},
            {name: "Life Ring", prices: {"6.5M":110,"7.6M":110,"8.5M":110,"9.5M":110,"11.5M":110,"13M":110}},
            {name: "Dive Bottle Rack (6 Bottles)", prices: {"6.5M":3250,"7.6M":3250,"8.5M":3250,"9.5M":3250,"11.5M":3250,"13M":3250}}
        ],
        "Protection & Guards": [
            {name: "Aluminium Bow Guard with Pushing Knee", prices: {"6.5M":8110,"7.6M":8110,"8.5M":8110,"9.5M":8110,"11.5M":8110,"13M":8110}},
            {name: "PE Filled Foam - Pushing Knee", prices: {"6.5M":4400,"7.6M":4400,"8.5M":4400,"9.5M":4400,"11.5M":4400,"13M":4400}},
            {name: "HD Aluminium Engine Guard", prices: {"6.5M":2800,"7.6M":2800,"8.5M":2800,"9.5M":2800,"11.5M":2800,"13M":2800}},
            {name: "Propeller Guard", prices: {"6.5M":1680,"7.6M":1680,"8.5M":1680,"9.5M":1680,"11.5M":1680,"13M":1680}},
            {name: "Wooden Pallet with Shrink-Wrap Packaging", prices: {"6.5M":1430,"7.6M":1430,"8.5M":1430,"9.5M":1430,"11.5M":1430,"13M":1430}}
        ],
        "Trailers": [
            {name: "Galvanized Steel Single Axis Trailer (Without Brakes)", prices: {"6.5M":5000,"7.6M":6000,"8.5M":"X","9.5M":"X","11.5M":"X","13M":"X"}},
            {name: "Galvanized Steel Double Trailer (Without Brakes)", prices: {"6.5M":"X","7.6M":"X","8.5M":7000,"9.5M":8000,"11.5M":"X","13M":"X"}},
            {name: "Galvanized Steel Triple Trailer (Without Brakes)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":10000,"13M":10000}}
        ],
        "GPS": [
            {name: "GARMIN GPSMAP 923 XSV 9\" MFD with Sonar", prices: {"6.5M":2270,"7.6M":2270,"8.5M":2270,"9.5M":2270,"11.5M":2270,"13M":2270}},
            {name: "GARMIN GPSMAP 8410 XSV 10\" MFD with Sonar", prices: {"6.5M":4400,"7.6M":4400,"8.5M":4400,"9.5M":4400,"11.5M":4400,"13M":4400}},
            {name: "GARMIN GPSMAP 8410 10\" MFD W/O Sonar", prices: {"6.5M":3500,"7.6M":3500,"8.5M":3500,"9.5M":3500,"11.5M":3500,"13M":3500}}
        ],
        "Radar": [
            {name: "GARMIN GMR 18HD+ 18NM Radar Scanner", prices: {"6.5M":2200,"7.6M":2200,"8.5M":2200,"9.5M":2200,"11.5M":2200,"13M":2200}},
            {name: "GARMIN GMR Fantom 18x Dome Radar", prices: {"6.5M":2600,"7.6M":2600,"8.5M":2600,"9.5M":2600,"11.5M":2600,"13M":2600}}
        ],
        "VHF": [
            {name: "Garmin 115i VHF Radio with Antenna", prices: {"6.5M":750,"7.6M":750,"8.5M":750,"9.5M":750,"11.5M":750,"13M":750}},
            {name: "Garmin 215i AIS VHF Radio with Antenna", prices: {"6.5M":1200,"7.6M":1200,"8.5M":1200,"9.5M":1200,"11.5M":1200,"13M":1200}}
        ],
        "Other Communication": [
            {name: "Whelen Siren/PA System IAW COLREGS", prices: {"6.5M":1100,"7.6M":1100,"8.5M":1100,"9.5M":1100,"11.5M":1100,"13M":1100}},
            {name: "Signal Horn 12VDC IAW COLREGS", prices: {"6.5M":250,"7.6M":250,"8.5M":250,"9.5M":250,"11.5M":250,"13M":250}}
        ],
        "FLIR / Thermal": [
            {name: "FLIR M232 Thermal Camera (320x240, 9Hz)", prices: {"6.5M":6500,"7.6M":6500,"8.5M":6500,"9.5M":6500,"11.5M":6500,"13M":6500}},
            {name: "FLIR M364C Gyro Stabilized Thermal IP Camera", prices: {"6.5M":27000,"7.6M":27000,"8.5M":27000,"9.5M":27000,"11.5M":27000,"13M":27000}}
        ],
        "Lighting & Electrical": [
            {name: "STL K-FORCE LED Law Enforcement Light Bar", prices: {"6.5M":1500,"7.6M":1500,"8.5M":1500,"9.5M":1500,"11.5M":1500,"13M":1500}},
            {name: "Remote Search Light ACR RCL 95 w/Joystick", prices: {"6.5M":1050,"7.6M":1050,"8.5M":1050,"9.5M":1050,"11.5M":1050,"13M":1050}},
            {name: "LED Flood Lights / Scene-Lights (4 pieces)", prices: {"6.5M":800,"7.6M":800,"8.5M":800,"9.5M":800,"11.5M":800,"13M":800}},
            {name: "Deck Light LED Tri-Color Lighting", prices: {"6.5M":1060,"7.6M":1060,"8.5M":1400,"9.5M":1400,"11.5M":1775,"13M":1775}},
            {name: "12 VDC Air-Compressor Tube Inflation System", prices: {"6.5M":400,"7.6M":400,"8.5M":400,"9.5M":400,"11.5M":400,"13M":400}},
            {name: "3-Bank Onboard Battery Charging System 40A", prices: {"6.5M":750,"7.6M":750,"8.5M":750,"9.5M":750,"11.5M":750,"13M":750}},
            {name: "BLUE SEA Accessory Receptacle 12VDC", prices: {"6.5M":75,"7.6M":75,"8.5M":75,"9.5M":75,"11.5M":75,"13M":75}},
            {name: "BLUE SEA 12VDC Dual USB Charging Outlets", prices: {"6.5M":100,"7.6M":100,"8.5M":100,"9.5M":100,"11.5M":100,"13M":100}},
            {name: "Plastimo Flush Mount Offshore Compass 95", prices: {"6.5M":380,"7.6M":380,"8.5M":380,"9.5M":380,"11.5M":380,"13M":380}}
        ]
    },
    fiberglass: {
        "Propulsion / Engine": [
            {name: "Single Mercury F150Hp EXLPT (incl. controls, steering, gauges)", prices: {"4.1M":18620,"5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Twin Mercury F150Hp XLPT/CXLPT (incl. controls, steering, gauges)", prices: {"4.1M":"X","5.1M":34255,"5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Twin Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 502)", prices: {"4.1M":"X","5.1M":"X","5.5M":68975,"6.5M":68975,"7.2M":68975,"8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Twin Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":103120,"7.2M":103120,"8.0M":103120,"8.5M":103120,"9.5M":103120,"12M":103120}},
            {name: "Triple Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 702)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":114950,"8.5M":114950,"9.5M":114950,"12M":114950}},
            {name: "Triple Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":166180,"8.5M":166180,"9.5M":166180,"12M":166180}}
        ],
        "General": [
            {name: "Hybrid Foam-Filled Tube-Set", prices: {"4.1M":9880,"5.1M":12010,"5.5M":12955,"6.5M":15310,"7.2M":16960,"8.0M":18840,"8.5M":20608,"9.5M":22375,"12M":29300}},
            {name: "Custom Color Hypalon", prices: {"4.1M":2500,"5.1M":3000,"5.5M":3500,"6.5M":4000,"7.2M":4500,"8.0M":5000,"8.5M":5000,"9.5M":5000,"12M":5000}},
            {name: "Double Layer Hypalon", prices: {"4.1M":15340,"5.1M":17500,"5.5M":20000,"6.5M":22420,"7.2M":27000,"8.0M":28320,"8.5M":28320,"9.5M":28320,"12M":28320}},
            {name: "Hypalon Strip Between Fender", prices: {"4.1M":2000,"5.1M":2200,"5.5M":2400,"6.5M":2600,"7.2M":2800,"8.0M":3000,"8.5M":3100,"9.5M":3300,"12M":3500}},
            {name: "Hypalon Non-Slip Step-Tread", prices: {"4.1M":1500,"5.1M":1700,"5.5M":2200,"6.5M":2500,"7.2M":2800,"8.0M":3000,"8.5M":3100,"9.5M":3200,"12M":3300}},
            {name: "Hypalon Branding And Numbering", prices: {"4.1M":700,"5.1M":700,"5.5M":700,"6.5M":700,"7.2M":700,"8.0M":700,"8.5M":700,"9.5M":700,"12M":700}},
            {name: "Extra Handle", prices: {"4.1M":50,"5.1M":50,"5.5M":50,"6.5M":50,"7.2M":50,"8.0M":50,"8.5M":50,"9.5M":50,"12M":50}},
            {name: "Diver-Notch", prices: {"4.1M":3200,"5.1M":3200,"5.5M":3200,"6.5M":3200,"7.2M":3200,"8.0M":3200,"8.5M":3200,"9.5M":3200,"12M":3200}},
            {name: "Notch Filling Inserts", prices: {"4.1M":2500,"5.1M":2500,"5.5M":2500,"6.5M":2500,"7.2M":3500,"8.0M":3500,"8.5M":3500,"9.5M":3500,"12M":3500}},
            {name: "Bow Step with 2 Stainless Steel Cleats", prices: {"4.1M":545,"5.1M":545,"5.5M":545,"6.5M":545,"7.2M":545,"8.0M":545,"8.5M":545,"9.5M":545,"12M":545}},
            {name: "Aluminium Anchor with S.S Chain", prices: {"4.1M":1075,"5.1M":1075,"5.5M":1075,"6.5M":1075,"7.2M":1075,"8.0M":1075,"8.5M":1075,"9.5M":1075,"12M":1075}},
            {name: "Aluminium Anchor with Rope 30m", prices: {"4.1M":390,"5.1M":390,"5.5M":390,"6.5M":390,"7.2M":390,"8.0M":390,"8.5M":390,"9.5M":390,"12M":390}},
            {name: "Windless Clipper with S.S Chain & Anchor", prices: {"4.1M":5360,"5.1M":5360,"5.5M":5360,"6.5M":5360,"7.2M":5360,"8.0M":5360,"8.5M":5360,"9.5M":5360,"12M":5360}},
            {name: "Boat Cover", prices: {"4.1M":2500,"5.1M":4000,"5.5M":4500,"6.5M":5000,"7.2M":5500,"8.0M":5500,"8.5M":5500,"9.5M":5500,"12M":5500}}
        ],
        "Console": [
            {name: "Single Futura Console with Forward Seat", prices: {"4.1M":"X","5.1M":4610,"5.5M":4610,"6.5M":4610,"7.2M":4610,"8.0M":4610,"8.5M":4610,"9.5M":4610,"12M":4610}},
            {name: "Single Futura Console without Forward Seat", prices: {"4.1M":"X","5.1M":3647,"5.5M":3647,"6.5M":3647,"7.2M":3647,"8.0M":3647,"8.5M":3647,"9.5M":3647,"12M":3647}},
            {name: "Double Futura Console with Forward Seat - Low Rail", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":6380,"7.2M":6380,"8.0M":6380,"8.5M":6380,"9.5M":6380,"12M":6380}},
            {name: "Double Futura Console with Forward Seat - High Rail", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":8390,"7.2M":8390,"8.0M":8390,"8.5M":8390,"9.5M":8390,"12M":8390}},
            {name: "Double Futura Console without Forward Seat - Low Rail", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":4950,"7.2M":4950,"8.0M":4950,"8.5M":4950,"9.5M":4950,"12M":4950}},
            {name: "Double Futura Console without Forward Seat - High Rail", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":6960,"7.2M":6960,"8.0M":6960,"8.5M":6960,"9.5M":6960,"12M":6960}},
            {name: "Aluminium Console with Windscreen and Grab Rail", prices: {"4.1M":10115,"5.1M":10115,"5.5M":10500,"6.5M":11200,"7.2M":12000,"8.0M":12000,"8.5M":12000,"9.5M":12800,"12M":12800}},
            {name: "Double Ballistic Console", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":5840,"7.2M":5840,"8.0M":5840,"8.5M":5840,"9.5M":5840,"12M":5840}},
            {name: "Double Console with Toilet", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":23570,"8.5M":23570,"9.5M":23570,"12M":23570}},
            {name: "Beachlander Console", prices: {"4.1M":"X","5.1M":2590,"5.5M":2590,"6.5M":2590,"7.2M":2590,"8.0M":2590,"8.5M":2590,"9.5M":2590,"12M":2590}},
            {name: "Jockey Seat Console", prices: {"4.1M":3480,"5.1M":3480,"5.5M":3480,"6.5M":3480,"7.2M":3480,"8.0M":3480,"8.5M":3480,"9.5M":3480,"12M":3480}},
            {name: "Mamba Console", prices: {"4.1M":"X","5.1M":3290,"5.5M":3290,"6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}}
        ],
        "Cabin / T-Top": [
            {name: "Aluminum Cabin for 4 PAX", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"TBD","7.2M":"TBD","8.0M":"TBD","8.5M":"TBD","9.5M":"TBD","12M":"TBD"}},
            {name: "Aluminum Cabin with Cuddy and Toilet", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":79570,"12M":79570}},
            {name: "Aluminum Wheel-house", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":19200,"8.5M":19200,"9.5M":19200,"12M":19200}},
            {name: "Standard HD T-Top", prices: {"4.1M":"X","5.1M":8300,"5.5M":8300,"6.5M":8300,"7.2M":8300,"8.0M":8300,"8.5M":8300,"9.5M":8300,"12M":8300}},
            {name: "S.S. HD T-Top", prices: {"4.1M":"X","5.1M":13250,"5.5M":13250,"6.5M":13250,"7.2M":13250,"8.0M":13250,"8.5M":13250,"9.5M":13250,"12M":13250}},
            {name: "Aluminium T-Top with Hard Top 1 (2.7m)", prices: {"4.1M":12560,"5.1M":12560,"5.5M":12560,"6.5M":12560,"7.2M":12560,"8.0M":12560,"8.5M":12560,"9.5M":12560,"12M":12560}},
            {name: "Aluminium T-Top with Hard Top 2 (3.8m)", prices: {"4.1M":14920,"5.1M":14920,"5.5M":14920,"6.5M":14920,"7.2M":14920,"8.0M":14920,"8.5M":14920,"9.5M":14920,"12M":14920}},
            {name: "Aluminium T-Top with Hard Top 3 (4.4m)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":26100,"8.0M":26100,"8.5M":26100,"9.5M":26100,"12M":26100}},
            {name: "Aluminium Foldable T-Top", prices: {"4.1M":"X","5.1M":10615,"5.5M":10615,"6.5M":10615,"7.2M":10615,"8.0M":10615,"8.5M":10615,"9.5M":10615,"12M":10615}},
            {name: "Extended Canopy to A-Frame", prices: {"4.1M":"X","5.1M":655,"5.5M":655,"6.5M":655,"7.2M":655,"8.0M":655,"8.5M":655,"9.5M":655,"12M":655}}
        ],
        "Leaning Posts": [
            {name: "Leaning Post Single", prices: {"4.1M":"X","5.1M":2765,"5.5M":2765,"6.5M":2765,"7.2M":2765,"8.0M":2765,"8.5M":2765,"9.5M":2765,"12M":2765}},
            {name: "Leaning Post with Back Rest Single", prices: {"4.1M":"X","5.1M":3310,"5.5M":3310,"6.5M":3310,"7.2M":3310,"8.0M":3310,"8.5M":3310,"9.5M":3310,"12M":3310}},
            {name: "Leaning Post Double", prices: {"4.1M":"X","5.1M":3400,"5.5M":3400,"6.5M":3400,"7.2M":3400,"8.0M":3400,"8.5M":3400,"9.5M":3400,"12M":3400}},
            {name: "Leaning Post With Back Rest Double", prices: {"4.1M":"X","5.1M":4000,"5.5M":4000,"6.5M":4000,"7.2M":4000,"8.0M":4000,"8.5M":4000,"9.5M":4000,"12M":4000}},
            {name: "Fiber Glass Leaning Post with Back Rest - Single", prices: {"4.1M":"X","5.1M":"X","5.5M":9000,"6.5M":9000,"7.2M":9000,"8.0M":9000,"8.5M":9000,"9.5M":9000,"12M":9000}}
        ],
        "Jockey & Straddle": [
            {name: "Grab Rail for Front Seat", prices: {"4.1M":650,"5.1M":650,"5.5M":650,"6.5M":650,"7.2M":650,"8.0M":650,"8.5M":650,"9.5M":650,"12M":650}},
            {name: "Straddle Seat with Handle", prices: {"4.1M":1980,"5.1M":1980,"5.5M":1980,"6.5M":1980,"7.2M":1980,"8.0M":1980,"8.5M":1980,"9.5M":1980,"12M":1980}},
            {name: "Single GRP Jockey Seat with Back Rail", prices: {"4.1M":1700,"5.1M":1700,"5.5M":1700,"6.5M":1700,"7.2M":1700,"8.0M":1700,"8.5M":1700,"9.5M":1700,"12M":1700}},
            {name: "Double GRP Jockey Seat with Back Rail", prices: {"4.1M":3400,"5.1M":3400,"5.5M":3400,"6.5M":3400,"7.2M":3400,"8.0M":3400,"8.5M":3400,"9.5M":3400,"12M":3400}}
        ],
        "Bench Seats": [
            {name: "Painted Aluminum Bench Seat 1 PAX with Storage", prices: {"4.1M":4420,"5.1M":4420,"5.5M":4420,"6.5M":4420,"7.2M":4420,"8.0M":4420,"8.5M":4420,"9.5M":4420,"12M":4420}},
            {name: "S.S. Bench Seat 1 PAX with Storage", prices: {"4.1M":5530,"5.1M":5530,"5.5M":5530,"6.5M":5530,"7.2M":5530,"8.0M":5530,"8.5M":5530,"9.5M":5530,"12M":5530}},
            {name: "Painted Aluminum Bench Seat 2 PAX with Storage", prices: {"4.1M":5150,"5.1M":5150,"5.5M":5150,"6.5M":5150,"7.2M":5150,"8.0M":5150,"8.5M":5150,"9.5M":5150,"12M":5150}},
            {name: "S.S. Bench Seat 2 PAX with Storage", prices: {"4.1M":6240,"5.1M":6240,"5.5M":6240,"6.5M":6240,"7.2M":6240,"8.0M":6240,"8.5M":6240,"9.5M":6240,"12M":6240}},
            {name: "Painted Aluminum Bench Seat 3 PAX with Storage", prices: {"4.1M":6570,"5.1M":6570,"5.5M":6570,"6.5M":6570,"7.2M":6570,"8.0M":6570,"8.5M":6570,"9.5M":6570,"12M":6570}},
            {name: "S.S. Bench Seat 3 PAX with Storage", prices: {"4.1M":7890,"5.1M":7890,"5.5M":7890,"6.5M":7890,"7.2M":7890,"8.0M":7890,"8.5M":7890,"9.5M":7890,"12M":7890}},
            {name: "Painted Aluminum Bench Seat 4 PAX with Storage", prices: {"4.1M":8360,"5.1M":8360,"5.5M":8360,"6.5M":8360,"7.2M":8360,"8.0M":8360,"8.5M":8360,"9.5M":8360,"12M":8360}},
            {name: "S.S. Bench Seat 4 PAX with Storage", prices: {"4.1M":8350,"5.1M":8350,"5.5M":8350,"6.5M":8350,"7.2M":8350,"8.0M":8350,"8.5M":8350,"9.5M":8350,"12M":8350}}
        ],
        "Suspension Seats": [
            {name: "Ullman BISCAYA Jockey Suspension Seat", prices: {"4.1M":5500,"5.1M":5500,"5.5M":5500,"6.5M":5500,"7.2M":5500,"8.0M":5500,"8.5M":5500,"9.5M":5500,"12M":5500}},
            {name: "Ullman Patrol Jockey Suspension Seat", prices: {"4.1M":6250,"5.1M":6250,"5.5M":6250,"6.5M":6250,"7.2M":6250,"8.0M":6250,"8.5M":6250,"9.5M":6250,"12M":6250}},
            {name: "Echelon Midback Jockey Suspension Seat", prices: {"4.1M":16300,"5.1M":16300,"5.5M":16300,"6.5M":16300,"7.2M":16300,"8.0M":16300,"8.5M":16300,"9.5M":16300,"12M":16300}}
        ],
        "A-Frame": [
            {name: "Aluminium A Frame", prices: {"4.1M":2885,"5.1M":2885,"5.5M":2885,"6.5M":2885,"7.2M":3260,"8.0M":3260,"8.5M":3400,"9.5M":3400,"12M":3600}},
            {name: "Aluminium A Frame With Self-righting System", prices: {"4.1M":9730,"5.1M":9730,"5.5M":9730,"6.5M":9730,"7.2M":10140,"8.0M":10140,"8.5M":10500,"9.5M":10500,"12M":10800}},
            {name: "Aluminium A Frame with Swim Platform and Ladder", prices: {"4.1M":4300,"5.1M":4300,"5.5M":4300,"6.5M":4300,"7.2M":4675,"8.0M":4675,"8.5M":4800,"9.5M":4800,"12M":5000}}
        ],
        "Other Frames & Structure": [
            {name: "Aluminium Tube Ladder", prices: {"4.1M":2500,"5.1M":2500,"5.5M":2500,"6.5M":2500,"7.2M":2500,"8.0M":2500,"8.5M":2500,"9.5M":2500,"12M":2500}},
            {name: "Swim Platform at Transom for Inboard Engine", prices: {"4.1M":1285,"5.1M":1285,"5.5M":1285,"6.5M":1285,"7.2M":1285,"8.0M":1285,"8.5M":1285,"9.5M":1285,"12M":1285}},
            {name: "Bow Tow Post", prices: {"4.1M":2230,"5.1M":2230,"5.5M":2230,"6.5M":2230,"7.2M":2230,"8.0M":2230,"8.5M":2230,"9.5M":2230,"12M":2230}},
            {name: "Aft Tow Post", prices: {"4.1M":2230,"5.1M":2230,"5.5M":2230,"6.5M":2230,"7.2M":2230,"8.0M":2230,"8.5M":2230,"9.5M":2230,"12M":2230}},
            {name: "Bollard", prices: {"4.1M":835,"5.1M":835,"5.5M":835,"6.5M":835,"7.2M":835,"8.0M":835,"8.5M":835,"9.5M":835,"12M":835}},
            {name: "Bow HD Tow Post w/Weapons Mount Flange", prices: {"4.1M":7000,"5.1M":7000,"5.5M":7000,"6.5M":7000,"7.2M":7000,"8.0M":7000,"8.5M":7000,"9.5M":7000,"12M":7000}},
            {name: "Aft HD Tow Post w/Weapons Mount Flange", prices: {"4.1M":7000,"5.1M":7000,"5.5M":7000,"6.5M":7000,"7.2M":7000,"8.0M":7000,"8.5M":7000,"9.5M":7000,"12M":7000}}
        ],
        "Life Jackets": [
            {name: "Life Jacket SOLAS Foam with Flashlight 170N", prices: {"4.1M":85,"5.1M":85,"5.5M":85,"6.5M":85,"7.2M":85,"8.0M":85,"8.5M":85,"9.5M":85,"12M":85}},
            {name: "Life Jacket Manual Inflatable 170N", prices: {"4.1M":120,"5.1M":120,"5.5M":120,"6.5M":120,"7.2M":120,"8.0M":120,"8.5M":120,"9.5M":120,"12M":120}}
        ],
        "Other Safety": [
            {name: "Distress Signal Kit for Coastal Navigation", prices: {"4.1M":200,"5.1M":200,"5.5M":200,"6.5M":200,"7.2M":200,"8.0M":200,"8.5M":200,"9.5M":200,"12M":200}},
            {name: "2x Fire Extinguisher (2Kg) IAW COLREGS", prices: {"4.1M":300,"5.1M":300,"5.5M":300,"6.5M":300,"7.2M":300,"8.0M":300,"8.5M":300,"9.5M":300,"12M":300}},
            {name: "2x 20\" USCG Approved Ring Buoy IAW COLREGS", prices: {"4.1M":160,"5.1M":160,"5.5M":160,"6.5M":160,"7.2M":160,"8.0M":160,"8.5M":160,"9.5M":160,"12M":160}},
            {name: "2x Mooring Rope 12mm 20m", prices: {"4.1M":300,"5.1M":300,"5.5M":300,"6.5M":300,"7.2M":300,"8.0M":300,"8.5M":300,"9.5M":300,"12M":300}},
            {name: "2x Gunwale Mounted Boat Hook", prices: {"4.1M":150,"5.1M":150,"5.5M":150,"6.5M":150,"7.2M":150,"8.0M":150,"8.5M":150,"9.5M":150,"12M":150}},
            {name: "Single Hoisting Lifting System", prices: {"4.1M":15000,"5.1M":15000,"5.5M":15000,"6.5M":15000,"7.2M":19500,"8.0M":19500,"8.5M":19500,"9.5M":19500,"12M":19500}},
            {name: "Anti-fouling Hull Bottom Paint", prices: {"4.1M":2575,"5.1M":3140,"5.5M":3460,"6.5M":3750,"7.2M":4275,"8.0M":4500,"8.5M":4500,"9.5M":4500,"12M":4500}},
            {name: "Life Ring", prices: {"4.1M":110,"5.1M":110,"5.5M":110,"6.5M":110,"7.2M":110,"8.0M":110,"8.5M":110,"9.5M":110,"12M":110}},
            {name: "Dive Bottle Rack (6 Bottles)", prices: {"4.1M":3250,"5.1M":3250,"5.5M":3250,"6.5M":3250,"7.2M":3250,"8.0M":3250,"8.5M":3250,"9.5M":3250,"12M":3250}}
        ],
        "Protection & Guards": [
            {name: "Aluminium Bow Guard with Pushing Knee", prices: {"4.1M":8110,"5.1M":8110,"5.5M":8110,"6.5M":8110,"7.2M":8110,"8.0M":8110,"8.5M":8110,"9.5M":8110,"12M":8110}},
            {name: "Foam Filled Pushing Knee", prices: {"4.1M":4400,"5.1M":4400,"5.5M":4400,"6.5M":4400,"7.2M":4400,"8.0M":4400,"8.5M":4400,"9.5M":4400,"12M":4400}},
            {name: "Keel Guard", prices: {"4.1M":1430,"5.1M":1430,"5.5M":1430,"6.5M":1430,"7.2M":1430,"8.0M":1430,"8.5M":1430,"9.5M":1430,"12M":1430}},
            {name: "Full Length Keel Guard (Bow Eyes to Transom)", prices: {"4.1M":2600,"5.1M":2600,"5.5M":3000,"6.5M":3000,"7.2M":3500,"8.0M":3500,"8.5M":3500,"9.5M":3500,"12M":3500}},
            {name: "HD Aluminium Engine Guard", prices: {"4.1M":3360,"5.1M":3360,"5.5M":3360,"6.5M":3360,"7.2M":3360,"8.0M":3360,"8.5M":3360,"9.5M":3360,"12M":3360}},
            {name: "Propeller Guard", prices: {"4.1M":1680,"5.1M":1680,"5.5M":1680,"6.5M":1680,"7.2M":1680,"8.0M":1680,"8.5M":1680,"9.5M":1680,"12M":1680}},
            {name: "Wooden Pallet with Shrink-Wrap Packaging", prices: {"4.1M":1430,"5.1M":1430,"5.5M":1430,"6.5M":1430,"7.2M":1430,"8.0M":1430,"8.5M":1430,"9.5M":1430,"12M":1430}}
        ],
        "Trailers": [
            {name: "Galvanized Steel Single Axis Trailer (Without Brakes)", prices: {"4.1M":5000,"5.1M":5500,"5.5M":6000,"6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Galvanized Steel Double Trailer (Without Brakes)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":7000,"7.2M":7000,"8.0M":8000,"8.5M":8000,"9.5M":8000,"12M":"X"}},
            {name: "Galvanized Steel Triple Trailer (Without Brakes)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":10000}}
        ],
        "GPS": [
            {name: "GARMIN GPSMAP 923 XSV 9\" MFD with Sonar", prices: {"4.1M":2270,"5.1M":2270,"5.5M":2270,"6.5M":2270,"7.2M":2270,"8.0M":2270,"8.5M":2270,"9.5M":2270,"12M":2270}},
            {name: "GARMIN GPSMAP 8410 XSV 10\" MFD with Sonar", prices: {"4.1M":4400,"5.1M":4400,"5.5M":4400,"6.5M":4400,"7.2M":4400,"8.0M":4400,"8.5M":4400,"9.5M":4400,"12M":4400}},
            {name: "GARMIN GPSMAP 8410 10\" MFD W/O Sonar", prices: {"4.1M":3500,"5.1M":3500,"5.5M":3500,"6.5M":3500,"7.2M":3500,"8.0M":3500,"8.5M":3500,"9.5M":3500,"12M":3500}}
        ],
        "Radar": [
            {name: "GARMIN GMR 18HD+ 18NM Radar Scanner", prices: {"4.1M":2200,"5.1M":2200,"5.5M":2200,"6.5M":2200,"7.2M":2200,"8.0M":2200,"8.5M":2200,"9.5M":2200,"12M":2200}},
            {name: "GARMIN GMR Fantom 18x Dome Radar", prices: {"4.1M":2600,"5.1M":2600,"5.5M":2600,"6.5M":2600,"7.2M":2600,"8.0M":2600,"8.5M":2600,"9.5M":2600,"12M":2600}}
        ],
        "VHF": [
            {name: "Garmin 115i VHF Radio with Antenna", prices: {"4.1M":750,"5.1M":750,"5.5M":750,"6.5M":750,"7.2M":750,"8.0M":750,"8.5M":750,"9.5M":750,"12M":750}},
            {name: "Garmin 215i AIS VHF Radio with Antenna", prices: {"4.1M":1200,"5.1M":1200,"5.5M":1200,"6.5M":1200,"7.2M":1200,"8.0M":1200,"8.5M":1200,"9.5M":1200,"12M":1200}}
        ],
        "Other Communication": [
            {name: "Whelen Siren/PA System IAW COLREGS", prices: {"4.1M":1100,"5.1M":1100,"5.5M":1100,"6.5M":1100,"7.2M":1100,"8.0M":1100,"8.5M":1100,"9.5M":1100,"12M":1100}},
            {name: "Signal Horn 12VDC IAW COLREGS", prices: {"4.1M":250,"5.1M":250,"5.5M":250,"6.5M":250,"7.2M":250,"8.0M":250,"8.5M":250,"9.5M":250,"12M":250}}
        ],
        "FLIR / Thermal": [
            {name: "FLIR M232 Thermal Camera (320x240, 9Hz)", prices: {"4.1M":6500,"5.1M":6500,"5.5M":6500,"6.5M":6500,"7.2M":6500,"8.0M":6500,"8.5M":6500,"9.5M":6500,"12M":6500}},
            {name: "FLIR M364C Gyro Stabilized Thermal IP Camera", prices: {"4.1M":27000,"5.1M":27000,"5.5M":27000,"6.5M":27000,"7.2M":27000,"8.0M":27000,"8.5M":27000,"9.5M":27000,"12M":27000}}
        ],
        "Lighting & Electrical": [
            {name: "STL K-FORCE LED Law Enforcement Light Bar", prices: {"4.1M":1500,"5.1M":1500,"5.5M":1500,"6.5M":1500,"7.2M":1500,"8.0M":1500,"8.5M":1500,"9.5M":1500,"12M":1500}},
            {name: "Remote Search Light ACR RCL 95 w/Joystick", prices: {"4.1M":1050,"5.1M":1050,"5.5M":1050,"6.5M":1050,"7.2M":1050,"8.0M":1050,"8.5M":1050,"9.5M":1050,"12M":1050}},
            {name: "LED Flood Lights / Scene-Lights (4 pieces)", prices: {"4.1M":800,"5.1M":800,"5.5M":800,"6.5M":800,"7.2M":800,"8.0M":800,"8.5M":800,"9.5M":800,"12M":800}},
            {name: "Deck Light LED Tri-Color Lighting", prices: {"4.1M":1060,"5.1M":1060,"5.5M":1400,"6.5M":1400,"7.2M":1775,"8.0M":1775,"8.5M":1775,"9.5M":1775,"12M":1775}},
            {name: "12 VDC Air-Compressor Tube Inflation System", prices: {"4.1M":400,"5.1M":400,"5.5M":400,"6.5M":400,"7.2M":400,"8.0M":400,"8.5M":400,"9.5M":400,"12M":400}},
            {name: "3-Bank Onboard Battery Charging System 40A", prices: {"4.1M":750,"5.1M":750,"5.5M":750,"6.5M":750,"7.2M":750,"8.0M":750,"8.5M":750,"9.5M":750,"12M":750}},
            {name: "BLUE SEA Accessory Receptacle 12VDC", prices: {"4.1M":75,"5.1M":75,"5.5M":75,"6.5M":75,"7.2M":75,"8.0M":75,"8.5M":75,"9.5M":75,"12M":75}},
            {name: "BLUE SEA 12VDC Dual USB Charging Outlets", prices: {"4.1M":100,"5.1M":100,"5.5M":100,"6.5M":100,"7.2M":100,"8.0M":100,"8.5M":100,"9.5M":100,"12M":100}},
            {name: "Plastimo Flush Mount Offshore Compass 95", prices: {"4.1M":380,"5.1M":380,"5.5M":380,"6.5M":380,"7.2M":380,"8.0M":380,"8.5M":380,"9.5M":380,"12M":380}}
        ]
    },
    inflatable: {
        "Optional Accessories": [
            {name: "Custom Color Hypalon", prices: {"2.8M":"TBD","3.2M":"TBD","3.5M":"TBD","4.2M":"TBD","4.8M":"TBD","5.1M":"TBD"}},
            {name: "Extra Bench Seat", prices: {"2.8M":650,"3.2M":700,"3.5M":730,"4.2M":990,"4.8M":990,"5.1M":990}},
            {name: "Extra Hypalon D-ring Patch", prices: {"2.8M":50,"3.2M":50,"3.5M":50,"4.2M":50,"4.8M":50,"5.1M":50}},
            {name: "Hypalon Pilot Handles", prices: {"2.8M":50,"3.2M":50,"3.5M":50,"4.2M":50,"4.8M":50,"5.1M":50}},
            {name: "Moulded Rubber Handles", prices: {"2.8M":250,"3.2M":250,"3.5M":250,"4.2M":250,"4.8M":250,"5.1M":250}}
        ]
    }
};

// Category groupings - maps subcategories to main groups
// flat: true means show category directly without group wrapper
const CATEGORY_GROUPS = {
    aluminum: [
        {
            name: "Propulsion / Engine",
            icon: "‚öôÔ∏è",
            flat: true,
            categories: ["Propulsion / Engine"]
        },
        {
            name: "ASIS Accessories",
            icon: "üõ†Ô∏è",
            categories: ["General", "Console", "Cabin / T-Top", "A-Frame", "Other Frames & Structure", "Protection & Guards", "Trailers"],
            subgroups: [
                {
                    name: "Seating",
                    categories: ["Leaning Posts", "Jockey & Grab Rail", "Suspension Seats"]
                },
                {
                    name: "Safety Equipment",
                    categories: ["Life Jackets", "Other Safety"]
                }
            ]
        },
        {
            name: "Electronics & Communication",
            icon: "üì°",
            categories: ["GPS", "Radar", "VHF", "Other Communication", "FLIR / Thermal", "Lighting & Electrical"]
        }
    ],
    fiberglass: [
        {
            name: "Propulsion / Engine",
            icon: "‚öôÔ∏è",
            flat: true,
            categories: ["Propulsion / Engine"]
        },
        {
            name: "ASIS Accessories",
            icon: "üõ†Ô∏è",
            categories: ["General", "Console", "Cabin / T-Top", "A-Frame", "Other Frames & Structure", "Protection & Guards", "Trailers"],
            subgroups: [
                {
                    name: "Seating",
                    categories: ["Leaning Posts", "Jockey & Straddle", "Bench Seats", "Suspension Seats"]
                },
                {
                    name: "Safety Equipment",
                    categories: ["Life Jackets", "Other Safety"]
                }
            ]
        },
        {
            name: "Electronics & Communication",
            icon: "üì°",
            categories: ["GPS", "Radar", "VHF", "Other Communication", "FLIR / Thermal", "Lighting & Electrical"]
        }
    ],
    inflatable: [
        {
            name: "ASIS Accessories",
            icon: "üõ†Ô∏è",
            flat: true,
            categories: ["Optional Accessories"]
        }
    ]
};

// Currency rates - AED fixed, EUR fetched from API
let RATES = {USD: 1, AED: 3.6725, EUR: 0.92}; // AED fixed, EUR fallback
let ratesLoaded = false;

// Update rate info display
function updateRateInfo() {
    const infoText = `1 USD = 3.6725 AED (fixed) | ${RATES.EUR.toFixed(4)} EUR ${ratesLoaded ? '(live)' : '(fallback)'}`;
    
    const rateInfo1 = document.getElementById('rateInfo1');
    const rateInfo2 = document.getElementById('rateInfo2');
    if (rateInfo1) rateInfo1.innerHTML = ratesLoaded ? `üü¢ ${infoText}` : `üü° ${infoText}`;
    if (rateInfo2) rateInfo2.innerHTML = ratesLoaded ? `üü¢ ${infoText}` : `üü° ${infoText}`;
}

// Fetch live EUR exchange rate on page load
async function fetchExchangeRates() {
    try {
        const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=EUR');
        const data = await response.json();
        RATES.EUR = data.rates.EUR;
        ratesLoaded = true;
        console.log('Live EUR rate loaded:', RATES.EUR);
        updateRateInfo();
        updateTotals();
    } catch (error) {
        console.warn('Could not fetch live EUR rate, using fallback:', error);
        updateRateInfo();
    }
}

// Call on page load
fetchExchangeRates();

// Salesman contact information
const SALESMEN = {
    mario: {
        name: "Mario Hoyek",
        email: "marioh@asisboats.com",
        phone: "+971 50 462 9258"
    },
    soufiane: {
        name: "Soufiane Tangi",
        email: "soufianet@asisboats.com",
        phone: "+971 50 551 2985"
    },
    toji: {
        name: "Toji Paul",
        email: "tojip@asisboats.com",
        phone: "+971 54 791 3337"
    }
};

// ==================== STATE ====================
let state = {
    boatType: null,
    sizeIdx: null,
    currency: 'USD',
    items: {},
    allExpanded: true
};

let itemCounter = 0;

// ==================== INIT ====================
function init() {
    document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
    renderBoatTypes();
    updateRateInfo();
}

// Toggle custom delivery input
function toggleDeliveryInput() {
    const select = document.getElementById('deliverySelect');
    const customInput = document.getElementById('deliveryCustom');
    if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
}

// Get delivery timeline value
function getDeliveryTimeline() {
    const select = document.getElementById('deliverySelect');
    if (select.value === 'custom') {
        return document.getElementById('deliveryCustom').value || 'TBD';
    }
    return select.value;
}

// ==================== UTILITIES ====================
function fmt(n) { return n.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}); }
function fmtPrice(n) {
    const converted = n * RATES[state.currency];
    const symbol = state.currency === 'EUR' ? '‚Ç¨' : state.currency === 'AED' ? 'AED ' : '$';
    return symbol + fmt(converted);
}
function getSelectedSize() {
    if (state.boatType && state.sizeIdx !== null) {
        return BOATS[state.boatType].sizes[state.sizeIdx].size;
    }
    return null;
}

// ==================== BOAT SELECTION ====================
function renderBoatTypes() {
    const grid = document.getElementById('boatTypesGrid');
    grid.innerHTML = '';
    Object.entries(BOATS).forEach(([key, boat]) => {
        const minPrice = Math.min(...boat.sizes.map(s => s.price));
        grid.innerHTML += `
            <div class="boat-type ${state.boatType === key ? 'selected' : ''}" onclick="selectBoatType('${key}')">
                <div class="boat-type-icon">${boat.icon}</div>
                <h3>${boat.name}</h3>
                <p>${boat.desc}</p>
                <div class="boat-type-stats">
                    <div class="stat"><div class="stat-val">${boat.sizes.length}</div><div class="stat-label">Sizes</div></div>
                    <div class="stat"><div class="stat-val">$${fmt(minPrice)}</div><div class="stat-label">From</div></div>
                </div>
            </div>`;
    });
}

function renderBoatSizes() {
    const grid = document.getElementById('boatSizesGrid');
    const boat = BOATS[state.boatType];
    grid.innerHTML = '';
    boat.sizes.forEach((s, i) => {
        grid.innerHTML += `
            <div class="boat-size ${state.sizeIdx === i ? 'selected' : ''}" onclick="selectBoatSize(${i})">
                <div class="size">${s.size}</div>
                <div class="price">${fmtPrice(s.price)}</div>
                <div class="specs">Fuel: ${s.fuel} | ${s.pax} PAX</div>
            </div>`;
    });
}

function selectBoatType(type) {
    state.boatType = type;
    state.sizeIdx = null;
    state.items = {};
    renderBoatTypes();
    document.getElementById('sizesCard').style.display = 'block';
    renderBoatSizes();
    document.getElementById('nextBtn1').disabled = true;
    updateTotals();
}

function selectBoatSize(idx) {
    state.sizeIdx = idx;
    state.items = {}; // Reset items when size changes
    renderBoatSizes();
    document.getElementById('nextBtn1').disabled = false;
    updateTotals();
    // Auto-advance to step 2
    setTimeout(() => goTo(2), 300);
}

// ==================== CATEGORIES ====================
// Check if a category is exclusive (radio buttons)
function isExclusiveCategory(cat) {
    return EXCLUSIVE_CATEGORIES.includes(cat);
}

// Helper function to build category HTML
function buildCategoryHtml(cat, accessories, selectedSize, isFlat, group) {
    const items = accessories[cat];
    if (!items) return { html: '', hasItems: false };
    
    // Filter items available for this size, keeping track of original index
    const availableItems = items.map((item, originalIdx) => ({...item, originalIdx}))
        .filter(item => {
            const price = item.prices[selectedSize];
            return price !== 'X' && price !== undefined;
        });
    
    if (availableItems.length === 0) return { html: '', hasItems: false };
    
    const catId = cat.replace(/[^a-zA-Z0-9]/g, '');
    const isExclusive = isExclusiveCategory(cat);
    
    // For flat groups, use the group name as header
    let displayName = cat;
    if (isFlat && group) {
        displayName = group.name;
    }
    
    // Determine flat color class
    let flatColorClass = '';
    if (isFlat && group) {
        if (group.name.toLowerCase().includes('engine') || group.name.toLowerCase().includes('propulsion')) {
            flatColorClass = 'engine-flat';
        } else if (group.name.toLowerCase().includes('accessories') || group.name.toLowerCase().includes('asis')) {
            flatColorClass = 'accessories-flat';
        } else if (group.name.toLowerCase().includes('electronic') || group.name.toLowerCase().includes('communication')) {
            flatColorClass = 'electronics-flat';
        }
    }
    
    const categoryClass = isFlat ? `category flat-category ${flatColorClass}` : 'category';
    
    // Build content based on exclusive vs multi-select
    let innerContent;
    if (isExclusive) {
        // Build radio button group
        innerContent = buildRadioGroupContent(cat, catId, availableItems, selectedSize);
    } else {
        // Build checkbox group
        innerContent = buildCheckboxGroupContent(cat, catId, availableItems, selectedSize);
    }
    
    const exclusiveBadge = isExclusive ? '<span class="exclusive-badge" style="background:var(--gold);color:white;font-size:9px;padding:2px 6px;border-radius:4px;margin-left:8px;">SELECT ONE</span>' : '';
    
    const html = `
        <div class="${categoryClass}">
            <div class="cat-header" onclick="toggleCategory('${catId}')">
                <h3>${isFlat && group ? `<span style="margin-right:10px;font-size:20px;">${group.icon}</span>` : ''}${displayName} ${exclusiveBadge}<span style="opacity:0.7;font-weight:400;font-size:11px;margin-left:8px;">(${availableItems.length} options)</span></h3>
                <div style="display:flex;align-items:center;gap:12px;">
                    <span class="cat-total" id="catTotal-${catId}">$0</span>
                    <span class="arrow">‚ñº</span>
                </div>
            </div>
            <div class="cat-content" id="content-${catId}">
                <div class="cat-inner">
                    ${innerContent}
                </div>
            </div>
        </div>`;
    
    return { html, hasItems: true, cat, isExclusive };
}

// Build radio button content for exclusive categories
function buildRadioGroupContent(cat, catId, availableItems, selectedSize) {
    let html = `<div class="radio-group" id="radio-${catId}">`;
    
    // Create nice "None" text based on category name
    let noneText = "No " + cat;
    if (cat === "Propulsion / Engine") noneText = "No Engine Selected";
    else if (cat === "Cabin / T-Top") noneText = "No Cabin or T-Top";
    else if (cat === "Leaning Posts") noneText = "No Leaning Post";
    else if (cat === "A-Frame") noneText = "No A-Frame";
    else if (cat === "Life Jackets") noneText = "No Life Jackets";
    else if (cat === "Trailers") noneText = "No Trailer";
    else if (cat === "GPS") noneText = "No GPS System";
    else if (cat === "Radar") noneText = "No Radar";
    else if (cat === "VHF") noneText = "No VHF Radio";
    else if (cat === "FLIR / Thermal") noneText = "No Thermal Camera";
    
    // Add "None" option first (default selected)
    html += `
        <label class="radio-option none-option selected" onclick="selectRadioOption('${cat}', -1, this)">
            <input type="radio" name="radio-${catId}" value="-1" checked>
            <div class="option-details">
                <div class="option-name">${noneText}</div>
            </div>
            <div class="option-price"></div>
        </label>`;
    
    // Add actual items
    availableItems.forEach((item) => {
        const price = item.prices[selectedSize];
        let priceDisplay;
        let priceClass = 'option-price';
        
        if (price === 'TBD') {
            // Show editable TBD input
            priceDisplay = `<div class="tbd-input-wrapper">
                <span>$</span>
                <input type="number" class="tbd-price-input" id="tbd-radio-${catId}-${item.originalIdx}" 
                    placeholder="TBD" min="0" step="100" 
                    onclick="event.stopPropagation()" 
                    onchange="updateTBDPrice('${cat}', ${item.originalIdx}, this.value, 'radio')">
            </div>`;
            priceClass = '';
        } else if (price === 'Incl.') {
            priceDisplay = 'Included';
        } else {
            priceDisplay = '$' + fmt(price);
        }
        
        html += `
            <label class="radio-option" onclick="selectRadioOption('${cat}', ${item.originalIdx}, this)">
                <input type="radio" name="radio-${catId}" value="${item.originalIdx}">
                <div class="option-details">
                    <div class="option-name">${item.name}</div>
                </div>
                <div class="${priceClass}">${priceDisplay}</div>
            </label>`;
    });
    
    // Add custom item input row
    html += `
        <div class="custom-item-row">
            <span class="custom-item-label">+ Add Custom:</span>
            <input type="text" placeholder="Item name" id="custom-name-${catId}">
            <input type="number" class="price-input" placeholder="Price" min="0" step="100" id="custom-price-${catId}">
            <button class="add-btn" onclick="addCustomItem('${cat}', '${catId}', 'radio')">Add</button>
        </div>`;
    
    html += '</div>';
    return html;
}

// Build checkbox content for non-exclusive categories
function buildCheckboxGroupContent(cat, catId, availableItems, selectedSize) {
    let html = `<div class="checkbox-group" id="checkbox-${catId}">`;
    
    // Add all items as checkboxes
    availableItems.forEach((item) => {
        const price = item.prices[selectedSize];
        const idx = item.originalIdx;
        let priceDisplay;
        let priceClass = 'option-price';
        
        if (price === 'TBD') {
            // Show editable TBD input
            priceDisplay = `<div class="tbd-input-wrapper">
                <span>$</span>
                <input type="number" class="tbd-price-input" id="tbd-chk-${catId}-${idx}" 
                    placeholder="TBD" min="0" step="100" 
                    onclick="event.stopPropagation()" 
                    onchange="updateTBDPrice('${cat}', ${idx}, this.value, 'checkbox')">
            </div>`;
            priceClass = '';
        } else if (price === 'Incl.') {
            priceDisplay = 'Included';
        } else {
            priceDisplay = '$' + fmt(price);
        }
        
        html += `
            <label class="checkbox-option" id="chk-${catId}-${idx}">
                <input type="checkbox" name="checkbox-${catId}" value="${idx}" onchange="toggleCheckboxOption('${cat}', ${idx}, this)">
                <div class="option-details">
                    <div class="option-name">${item.name}</div>
                </div>
                <div class="qty-control">
                    <input type="number" value="0" min="0" max="99" id="qty-${catId}-${idx}" onchange="updateCheckboxQty('${cat}', ${idx})" onclick="event.stopPropagation()">
                </div>
                <div class="${priceClass}" id="price-${catId}-${idx}">${priceDisplay}</div>
                <div class="option-extended" id="ext-${catId}-${idx}">$0</div>
            </label>`;
    });
    
    // Add custom item input row
    html += `
        <div class="custom-item-row">
            <span class="custom-item-label">+ Add Custom:</span>
            <input type="text" placeholder="Item name" id="custom-name-${catId}">
            <input type="number" style="width:50px;" placeholder="Qty" min="1" value="1" id="custom-qty-${catId}">
            <input type="number" class="price-input" placeholder="Price" min="0" step="100" id="custom-price-${catId}">
            <button class="add-btn" onclick="addCustomItem('${cat}', '${catId}', 'checkbox')">Add</button>
        </div>`;
    
    html += '</div>';
    return html;
}

// Handle radio button selection
function selectRadioOption(category, itemIdx, element) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const radioGroup = document.getElementById('radio-' + catId);
    
    // Remove selected class from all options
    radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
    
    // Add selected class to clicked option
    element.classList.add('selected');
    
    // Check the radio input
    element.querySelector('input[type="radio"]').checked = true;
    
    // Update state
    if (!state.items[category]) state.items[category] = {};
    
    // Clear previous selections in this category
    state.items[category] = {};
    
    if (itemIdx === -1) {
        // "None" selected - no item
        state.items[category]['radio'] = {itemIdx: -1, qty: 0, price: 0, name: 'None', isCustom: false, isTBD: false};
    } else {
        const selectedSize = getSelectedSize();
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        // Handle various price types: number, 'TBD', 'Incl.', undefined
        let numericPrice = 0;
        let isTBD = false;
        if (typeof price === 'number' && !isNaN(price)) {
            numericPrice = price;
        } else if (price === 'TBD') {
            isTBD = true;
            // Check if there's a TBD input with a value
            const tbdInput = document.getElementById(`tbd-radio-${catId}-${itemIdx}`);
            if (tbdInput && tbdInput.value) {
                numericPrice = parseFloat(tbdInput.value) || 0;
                isTBD = (numericPrice === 0);
            }
        }
        // 'Incl.' and undefined both result in price = 0
        
        state.items[category]['radio'] = {
            itemIdx: itemIdx,
            qty: 1,
            price: numericPrice,
            name: item.name,
            isCustom: false,
            isTBD: isTBD
        };
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Handle checkbox toggle
function toggleCheckboxOption(category, itemIdx, checkbox) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const label = document.getElementById(`chk-${catId}-${itemIdx}`);
    const qtyInput = document.getElementById(`qty-${catId}-${itemIdx}`);
    const extDiv = document.getElementById(`ext-${catId}-${itemIdx}`);
    
    if (!state.items[category]) state.items[category] = {};
    
    if (checkbox.checked) {
        label.classList.add('selected');
        // Set qty to 1 when checked
        qtyInput.value = 1;
        
        const selectedSize = getSelectedSize();
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        // Handle various price types
        let numericPrice = 0;
        let isTBD = false;
        if (typeof price === 'number' && !isNaN(price)) {
            numericPrice = price;
        } else if (price === 'TBD') {
            isTBD = true;
            // Check if there's a TBD input with a value
            const tbdInput = document.getElementById(`tbd-chk-${catId}-${itemIdx}`);
            if (tbdInput && tbdInput.value) {
                numericPrice = parseFloat(tbdInput.value) || 0;
                isTBD = (numericPrice === 0);
            }
        }
        
        state.items[category][itemIdx] = {
            itemIdx: itemIdx,
            qty: 1,
            price: numericPrice,
            name: item.name,
            isCustom: false,
            isTBD: isTBD
        };
        
        // Update extended price
        if (isTBD) {
            extDiv.innerHTML = '<span class="tbd">TBD</span>';
        } else if (price === 'Incl.') {
            extDiv.textContent = 'Incl.';
        } else {
            extDiv.textContent = '$' + fmt(numericPrice);
        }
    } else {
        label.classList.remove('selected');
        qtyInput.value = 0;
        delete state.items[category][itemIdx];
        extDiv.textContent = '$0';
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Update checkbox quantity
function updateCheckboxQty(category, itemIdx) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const qtyInput = document.getElementById(`qty-${catId}-${itemIdx}`);
    const checkbox = document.querySelector(`#chk-${catId}-${itemIdx} input[type="checkbox"]`);
    const label = document.getElementById(`chk-${catId}-${itemIdx}`);
    const extDiv = document.getElementById(`ext-${catId}-${itemIdx}`);
    
    const qty = parseInt(qtyInput.value) || 0;
    
    if (!state.items[category]) state.items[category] = {};
    
    if (qty > 0) {
        // Auto-check if qty > 0
        checkbox.checked = true;
        label.classList.add('selected');
        
        const selectedSize = getSelectedSize();
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        // Handle various price types
        let numericPrice = 0;
        let isTBD = false;
        if (typeof price === 'number' && !isNaN(price)) {
            numericPrice = price;
        } else if (price === 'TBD') {
            isTBD = true;
            // Check if there's a TBD input with a value
            const tbdInput = document.getElementById(`tbd-chk-${catId}-${itemIdx}`);
            if (tbdInput && tbdInput.value) {
                numericPrice = parseFloat(tbdInput.value) || 0;
                isTBD = (numericPrice === 0);
            }
        }
        
        state.items[category][itemIdx] = {
            itemIdx: itemIdx,
            qty: qty,
            price: numericPrice,
            name: item.name,
            isCustom: false,
            isTBD: isTBD
        };
        
        // Update extended price
        if (isTBD) {
            extDiv.innerHTML = '<span class="tbd">TBD</span>';
        } else if (price === 'Incl.') {
            extDiv.textContent = 'Incl.';
        } else {
            extDiv.textContent = '$' + fmt(numericPrice * qty);
        }
    } else {
        // Auto-uncheck if qty = 0
        checkbox.checked = false;
        label.classList.remove('selected');
        delete state.items[category][itemIdx];
        extDiv.textContent = '$0';
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Update TBD price when user enters a value
function updateTBDPrice(category, itemIdx, value, type) {
    const price = parseFloat(value) || 0;
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    
    if (!state.items[category]) state.items[category] = {};
    
    if (type === 'radio') {
        // For radio buttons, update the 'radio' entry
        if (state.items[category]['radio'] && state.items[category]['radio'].itemIdx === itemIdx) {
            state.items[category]['radio'].price = price;
            state.items[category]['radio'].isTBD = (price === 0);
        }
    } else {
        // For checkboxes, update the specific item entry
        if (state.items[category][itemIdx]) {
            state.items[category][itemIdx].price = price;
            state.items[category][itemIdx].isTBD = (price === 0);
            
            // Update extended price display
            const extDiv = document.getElementById(`ext-${catId}-${itemIdx}`);
            const qty = state.items[category][itemIdx].qty || 1;
            if (price > 0) {
                extDiv.textContent = '$' + fmt(price * qty);
            } else {
                extDiv.innerHTML = '<span class="tbd">TBD</span>';
            }
        }
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Add custom item to a category
function addCustomItem(category, catId, type) {
    const nameInput = document.getElementById(`custom-name-${catId}`);
    const priceInput = document.getElementById(`custom-price-${catId}`);
    const qtyInput = document.getElementById(`custom-qty-${catId}`);
    
    const name = nameInput.value.trim();
    const price = parseFloat(priceInput.value) || 0;
    const qty = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
    
    if (!name) {
        alert('Please enter an item name');
        nameInput.focus();
        return;
    }
    
    if (!state.items[category]) state.items[category] = {};
    
    // Generate unique custom item ID
    itemCounter++;
    const customId = `custom_${itemCounter}`;
    
    if (type === 'radio') {
        // For radio (exclusive) categories, replace current selection
        state.items[category] = {};
        state.items[category]['radio'] = {
            itemIdx: customId,
            qty: 1,
            price: price,
            name: name,
            isCustom: true,
            isTBD: false
        };
        
        // Add visual indicator - create a custom selected option
        const radioGroup = document.getElementById(`radio-${catId}`);
        
        // Remove selected class from all options
        radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
        
        // Add custom item display at the top (after None)
        const existingCustom = radioGroup.querySelector('.custom-added-item');
        if (existingCustom) existingCustom.remove();
        
        const customLabel = document.createElement('label');
        customLabel.className = 'radio-option selected custom-added-item';
        customLabel.innerHTML = `
            <input type="radio" name="radio-${catId}" value="${customId}" checked>
            <div class="option-details">
                <div class="option-name">‚ú® ${name}</div>
            </div>
            <div class="option-price" style="color:var(--success);">$${fmt(price)}</div>
        `;
        customLabel.onclick = function() {
            radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            customLabel.classList.add('selected');
            state.items[category]['radio'] = {
                itemIdx: customId,
                qty: 1,
                price: price,
                name: name,
                isCustom: true,
                isTBD: false
            };
            updateCategoryTotal(category);
            updateTotals();
        };
        
        // Insert after "None" option
        const noneOption = radioGroup.querySelector('.none-option');
        if (noneOption) {
            noneOption.after(customLabel);
        } else {
            radioGroup.insertBefore(customLabel, radioGroup.firstChild);
        }
        
    } else {
        // For checkbox (multi-select) categories, add to the list
        state.items[category][customId] = {
            itemIdx: customId,
            qty: qty,
            price: price,
            name: name,
            isCustom: true,
            isTBD: false
        };
        
        // Add visual indicator
        const checkboxGroup = document.getElementById(`checkbox-${catId}`);
        
        const customLabel = document.createElement('label');
        customLabel.className = 'checkbox-option selected custom-added-item';
        customLabel.id = `chk-${catId}-${customId}`;
        customLabel.innerHTML = `
            <input type="checkbox" checked>
            <div class="option-details">
                <div class="option-name">‚ú® ${name}</div>
            </div>
            <div class="qty-control">
                <input type="number" value="${qty}" min="0" max="99" onchange="updateCustomQty('${category}', '${customId}', this.value)" onclick="event.stopPropagation()">
            </div>
            <div class="option-price" style="color:var(--success);">$${fmt(price)}</div>
            <div class="option-extended" style="color:var(--success);">$${fmt(price * qty)}</div>
        `;
        
        // Insert before the custom-item-row
        const customRow = checkboxGroup.querySelector('.custom-item-row');
        if (customRow) {
            checkboxGroup.insertBefore(customLabel, customRow);
        } else {
            checkboxGroup.appendChild(customLabel);
        }
        
        // Add click handler to toggle
        customLabel.querySelector('input[type="checkbox"]').onchange = function() {
            if (this.checked) {
                customLabel.classList.add('selected');
                state.items[category][customId] = {
                    itemIdx: customId,
                    qty: parseInt(customLabel.querySelector('input[type="number"]').value) || 1,
                    price: price,
                    name: name,
                    isCustom: true,
                    isTBD: false
                };
            } else {
                customLabel.classList.remove('selected');
                delete state.items[category][customId];
            }
            updateCategoryTotal(category);
            updateTotals();
        };
    }
    
    // Clear inputs
    nameInput.value = '';
    priceInput.value = '';
    if (qtyInput) qtyInput.value = '1';
    
    updateCategoryTotal(category);
    updateTotals();
}

// Update custom item quantity
function updateCustomQty(category, customId, value) {
    const qty = parseInt(value) || 0;
    
    if (qty > 0 && state.items[category] && state.items[category][customId]) {
        state.items[category][customId].qty = qty;
        
        // Update extended display
        const catId = category.replace(/[^a-zA-Z0-9]/g, '');
        const label = document.getElementById(`chk-${catId}-${customId}`);
        if (label) {
            const price = state.items[category][customId].price;
            const extDiv = label.querySelector('.option-extended');
            if (extDiv) {
                extDiv.textContent = '$' + fmt(price * qty);
            }
        }
    } else if (qty === 0 && state.items[category]) {
        delete state.items[category][customId];
        // Uncheck the checkbox
        const catId = category.replace(/[^a-zA-Z0-9]/g, '');
        const label = document.getElementById(`chk-${catId}-${customId}`);
        if (label) {
            label.classList.remove('selected');
            const checkbox = label.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
        }
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

function buildCategories() {
    const container = document.getElementById('categoriesContainer');
    container.innerHTML = '';
    
    if (!state.boatType) return;
    
    const accessories = ACCESSORIES[state.boatType];
    const groups = CATEGORY_GROUPS[state.boatType];
    const selectedSize = getSelectedSize();
    
    document.getElementById('selectedBoatLabel').textContent = 
        `${BOATS[state.boatType].name} - ${selectedSize}`;
    
    // Track exclusive categories to initialize with "None"
    const exclusiveCategories = [];
    
    // Build each main group
    groups.forEach((group, groupIdx) => {
        let groupHtml = '';
        let groupHasItems = false;
        
        // Build regular categories within this group
        if (group.categories) {
            group.categories.forEach(cat => {
                const result = buildCategoryHtml(cat, accessories, selectedSize, group.flat, group);
                if (result.hasItems) {
                    groupHasItems = true;
                    if (result.isExclusive) {
                        exclusiveCategories.push(result.cat);
                    }
                    if (group.flat) {
                        container.innerHTML += result.html;
                    } else {
                        groupHtml += result.html;
                    }
                }
            });
        }
        
        // Build subgroups (e.g., Seating containing Leaning Posts, Jockey, etc.)
        if (group.subgroups) {
            group.subgroups.forEach((subgroup, subgroupIdx) => {
                let subgroupHtml = '';
                let subgroupHasItems = false;
                
                subgroup.categories.forEach(cat => {
                    const result = buildCategoryHtml(cat, accessories, selectedSize, false, null);
                    if (result.hasItems) {
                        subgroupHasItems = true;
                        groupHasItems = true;
                        if (result.isExclusive) {
                            exclusiveCategories.push(result.cat);
                        }
                        subgroupHtml += result.html;
                    }
                });
                
                if (subgroupHasItems) {
                    const subgroupId = `subgroup-${groupIdx}-${subgroupIdx}`;
                    groupHtml += `
                        <div class="subgroup">
                            <div class="subgroup-header" onclick="toggleSubgroup('${subgroupId}')">
                                <h4>${subgroup.name}</h4>
                                <div style="display:flex;align-items:center;">
                                    <span class="subgroup-total" id="subgroupTotal-${subgroupId}">$0</span>
                                    <span class="subgroup-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="subgroup-content" id="${subgroupId}">
                                <div class="subgroup-inner">
                                    ${subgroupHtml}
                                </div>
                            </div>
                        </div>`;
                }
            });
        }
        
        if (!groupHasItems) return;
        
        // Determine color class based on group name
        let colorClass = '';
        if (group.name.toLowerCase().includes('engine') || group.name.toLowerCase().includes('propulsion')) {
            colorClass = 'main-group-engine';
        } else if (group.name.toLowerCase().includes('accessories') || group.name.toLowerCase().includes('asis')) {
            colorClass = 'main-group-accessories';
        } else if (group.name.toLowerCase().includes('electronic') || group.name.toLowerCase().includes('communication')) {
            colorClass = 'main-group-electronics';
        }
        
        // For non-flat groups, wrap in main group container
        if (!group.flat && groupHtml) {
            const groupId = 'group-' + groupIdx;
            container.innerHTML += `
                <div class="main-group ${colorClass}">
                    <div class="main-group-header" onclick="toggleMainGroup('${groupId}')">
                        <h2><span class="group-icon">${group.icon}</span> ${group.name}</h2>
                        <div style="display:flex;align-items:center;">
                            <span class="group-total" id="groupTotal-${groupIdx}">$0</span>
                            <span class="group-arrow">‚ñº</span>
                        </div>
                    </div>
                    <div class="main-group-content" id="${groupId}">
                        <div class="main-group-inner">
                            ${groupHtml}
                        </div>
                    </div>
                </div>`;
        }
    });
    
    // Initialize exclusive categories with "None" selected (qty=0)
    exclusiveCategories.forEach(cat => {
        if (!state.items[cat]) state.items[cat] = {};
        state.items[cat]['radio'] = {itemIdx: -1, qty: 0, price: 0, name: 'None', isCustom: false, isTBD: false};
        // Update total to hide $0 for "None" selection
        updateCategoryTotal(cat);
    });
}

function toggleMainGroup(groupId) {
    const content = document.getElementById(groupId);
    const header = content.previousElementSibling;
    content.classList.toggle('open');
    header.classList.toggle('open');
}

function toggleSubgroup(subgroupId) {
    const content = document.getElementById(subgroupId);
    const header = content.previousElementSibling;
    content.classList.toggle('open');
    header.classList.toggle('open');
}

function toggleCategory(catId) {
    const content = document.getElementById('content-' + catId);
    const header = content.previousElementSibling;
    content.classList.toggle('open');
    header.classList.toggle('open');
}

function addItem(category) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const itemsDiv = document.getElementById('items-' + catId);
    const id = ++itemCounter;
    const selectedSize = getSelectedSize();
    const accessories = ACCESSORIES[state.boatType][category];
    
    // Build options - only show items available for this size
    let options = '<option value="">-- Select Item --</option>';
    accessories.forEach((item, i) => {
        const price = item.prices[selectedSize];
        if (price === 'X' || price === undefined) return; // Skip unavailable
        
        let priceDisplay;
        if (price === 'TBD') {
            priceDisplay = 'TBD';
        } else if (price === 'Incl.') {
            priceDisplay = 'Included';
        } else {
            priceDisplay = '$' + fmt(price);
        }
        options += `<option value="${i}">${item.name} - ${priceDisplay}</option>`;
    });
    options += '<option value="custom">+ Custom Item</option>';
    
    const row = document.createElement('div');
    row.className = 'item-row';
    row.id = 'row-' + id;
    row.innerHTML = `
        <select onchange="itemSelected(this, '${category}', ${id})">${options}</select>
        <input type="number" value="0" min="0" id="qty-${id}" onchange="updateItemQty(${id}, '${category}')">
        <input type="text" class="price-input" id="price-${id}" value="$0" onchange="updateItemPrice(${id}, '${category}')">
        <div class="extended" id="ext-${id}">$0</div>
        <button class="delete-btn" onclick="removeItem(${id}, '${category}')">√ó</button>
    `;
    itemsDiv.appendChild(row);
    
    if (!state.items[category]) state.items[category] = {};
    state.items[category][id] = {itemIdx: null, qty: 0, price: 0, name: '', isCustom: false, isTBD: false};
}

function itemSelected(select, category, id) {
    const val = select.value;
    const priceInput = document.getElementById('price-' + id);
    const extDiv = document.getElementById('ext-' + id);
    const selectedSize = getSelectedSize();
    
    if (val === 'custom') {
        const parent = select.parentElement;
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'custom-input';
        input.placeholder = 'Enter custom item name...';
        input.id = 'name-' + id;
        input.onchange = () => updateCustomItem(id, category);
        parent.replaceChild(input, select);
        
        state.items[category][id].isCustom = true;
        state.items[category][id].itemIdx = -1;
        priceInput.value = '$0';
        priceInput.focus();
    } else if (val !== '') {
        const itemIdx = parseInt(val);
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        state.items[category][id].itemIdx = itemIdx;
        state.items[category][id].name = item.name;
        
        if (price === 'TBD') {
            state.items[category][id].price = 0;
            state.items[category][id].isTBD = true;
            priceInput.value = 'TBD';
            priceInput.disabled = true;
            extDiv.innerHTML = '<span class="tbd">TBD</span>';
        } else if (price === 'Incl.') {
            state.items[category][id].price = 0;
            state.items[category][id].isTBD = false;
            priceInput.value = 'Included';
            priceInput.disabled = true;
            extDiv.textContent = 'Incl.';
        } else {
            state.items[category][id].price = price;
            state.items[category][id].isTBD = false;
            priceInput.value = '$' + fmt(price);
            priceInput.disabled = false;
        }
    } else {
        state.items[category][id].itemIdx = null;
        state.items[category][id].price = 0;
        state.items[category][id].name = '';
        state.items[category][id].isTBD = false;
        priceInput.value = '$0';
        priceInput.disabled = false;
    }
    
    updateItemExtended(id, category);
    updateCategoryTotal(category);
    updateTotals();
}

function updateCustomItem(id, category) {
    const nameInput = document.getElementById('name-' + id);
    state.items[category][id].name = nameInput.value;
}

function updateItemQty(id, category) {
    const qty = parseInt(document.getElementById('qty-' + id).value) || 1;
    state.items[category][id].qty = qty;
    updateItemExtended(id, category);
    updateCategoryTotal(category);
    updateTotals();
}

function updateItemPrice(id, category) {
    const priceInput = document.getElementById('price-' + id);
    const price = parseFloat(priceInput.value.replace(/[^0-9.]/g, '')) || 0;
    state.items[category][id].price = price;
    priceInput.value = '$' + fmt(price);
    updateItemExtended(id, category);
    updateCategoryTotal(category);
    updateTotals();
}

function updateItemExtended(id, category) {
    const item = state.items[category][id];
    if (item.isTBD) {
        document.getElementById('ext-' + id).innerHTML = '<span class="tbd">TBD</span>';
    } else {
        const extended = item.price * item.qty;
        document.getElementById('ext-' + id).textContent = '$' + fmt(extended);
    }
}

function removeItem(id, category) {
    document.getElementById('row-' + id).remove();
    delete state.items[category][id];
    updateCategoryTotal(category);
    updateTotals();
}

function updateCategoryTotal(category) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    let total = 0;
    
    if (state.items[category]) {
        Object.values(state.items[category]).forEach(item => {
            // Check if this is a real selection (not "None" which has itemIdx -1)
            if (item.itemIdx !== -1 && item.qty > 0) {
                if (item.price && !item.isTBD) {
                    total += item.price * item.qty;
                }
            }
        });
    }
    
    const el = document.getElementById('catTotal-' + catId);
    if (el) {
        el.textContent = '$' + fmt(total);
        el.style.display = 'inline-block';
    }
}

// ==================== TOTALS ====================
function updateTotals() {
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const basePerBoat = state.boatType && state.sizeIdx !== null ? BOATS[state.boatType].sizes[state.sizeIdx].price : 0;
    const base = basePerBoat * boatQty;
    let optionsPerBoat = 0;
    
    Object.values(state.items).forEach(cat => {
        Object.values(cat).forEach(item => {
            if (item.price && item.qty && !item.isTBD) {
                optionsPerBoat += item.price * item.qty;
            }
        });
    });
    
    const options = optionsPerBoat * boatQty;
    const subtotal = base + options;
    const discountPct = parseFloat(document.getElementById('discount')?.value) || 0;
    const discount = subtotal * (discountPct / 100);
    const total = subtotal - discount;
    
    // Update summaries
    const qtyLabel = boatQty > 1 ? ` (√ó${boatQty})` : '';
    document.getElementById('sumType').textContent = state.boatType ? BOATS[state.boatType].name : '-';
    document.getElementById('sumSize').textContent = state.sizeIdx !== null ? BOATS[state.boatType].sizes[state.sizeIdx].size : '-';
    document.getElementById('sumBase').textContent = basePerBoat ? fmtPrice(base) + qtyLabel : '-';
    document.getElementById('sumOptions').textContent = fmtPrice(options);
    document.getElementById('sumTotal').textContent = fmtPrice(total);
    
    const sumTotal2 = document.getElementById('sumTotal2');
    if (sumTotal2) sumTotal2.textContent = fmtPrice(total);
    
    const sumSub3 = document.getElementById('sumSub3');
    if (sumSub3) sumSub3.textContent = fmtPrice(subtotal);
    const sumDisc3 = document.getElementById('sumDisc3');
    if (sumDisc3) sumDisc3.textContent = '-' + fmtPrice(discount);
    const sumTotal3 = document.getElementById('sumTotal3');
    if (sumTotal3) sumTotal3.textContent = fmtPrice(total);
    
    // Update selected items list
    updateSelectedItemsList();
}

function updateSelectedItemsList() {
    const list = document.getElementById('selectedItemsList');
    if (!list) return;
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    
    let html = '';
    if (state.boatType && state.sizeIdx !== null) {
        const boatPrice = BOATS[state.boatType].sizes[state.sizeIdx].price * boatQty;
        const qtyLabel = boatQty > 1 ? `${boatQty}√ó ` : '';
        html += `<div class="sel-item"><span class="name">${qtyLabel}${BOATS[state.boatType].sizes[state.sizeIdx].size} ${BOATS[state.boatType].name}</span><span class="amt">${fmtPrice(boatPrice)}</span></div>`;
    }
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            // Skip "None" selections (itemIdx === -1)
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                const totalQty = item.qty * boatQty;
                const amt = item.isTBD ? 'TBD' : fmtPrice(item.price * item.qty * boatQty);
                html += `<div class="sel-item"><span class="name">${totalQty}√ó ${item.name}</span><span class="amt">${amt}</span></div>`;
            }
        });
    });
    
    list.innerHTML = html || '<div style="color:var(--gray-500);font-size:12px;">No items selected</div>';
}

// ==================== CURRENCY ====================
function setCurrency(curr) {
    state.currency = curr;
    document.querySelectorAll('.curr-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll(`.curr-btn`).forEach(b => {
        if (b.textContent === curr) b.classList.add('active');
    });
    if (state.boatType) renderBoatSizes();
    updateTotals();
}

// ==================== NAVIGATION ====================
function goTo(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page' + page).classList.add('active');
    
    document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'done');
        if (i + 1 < page) s.classList.add('done');
        if (i + 1 === page) s.classList.add('active');
    });
    
    if (page === 2) {
        buildCategories();
        // Auto-open all categories
        openAllCategories();
    }
    if (page === 3) {
        // Set default quotation title based on boat type and size
        const titleField = document.getElementById('quoteTitle');
        if (!titleField.value) {
            const size = getSelectedSize();
            const boatType = state.boatType;
            if (size && boatType) {
                let typeName = '';
                if (boatType === 'aluminum') typeName = 'Aluminum RIB Boats';
                else if (boatType === 'fiberglass') typeName = 'Fiberglass RIB Boats';
                else if (boatType === 'inflatable') typeName = 'Inflatable Boats';
                titleField.value = `${size} ${typeName}`;
            }
        }
    }
    if (page === 4) {
        buildPreview();
    }
    
    window.scrollTo(0, 0);
}

// Open all categories, main groups, and subgroups
function openAllCategories() {
    // Open all main groups
    document.querySelectorAll('.main-group-content').forEach(content => {
        content.classList.add('open');
        content.previousElementSibling.classList.add('open');
    });
    
    // Open all subgroups
    document.querySelectorAll('.subgroup-content').forEach(content => {
        content.classList.add('open');
        content.previousElementSibling.classList.add('open');
    });
    
    // Open all categories
    document.querySelectorAll('.cat-content').forEach(content => {
        content.classList.add('open');
        content.previousElementSibling.classList.add('open');
    });
    
    // Update button text
    const btn = document.getElementById('toggleAllBtn');
    if (btn) btn.innerHTML = '‚ñ≤ Collapse All';
    state.allExpanded = true;
}

function closeAllCategories() {
    // Close all main groups
    document.querySelectorAll('.main-group-content').forEach(content => {
        content.classList.remove('open');
        content.previousElementSibling.classList.remove('open');
    });
    
    // Close all subgroups
    document.querySelectorAll('.subgroup-content').forEach(content => {
        content.classList.remove('open');
        content.previousElementSibling.classList.remove('open');
    });
    
    // Close all categories
    document.querySelectorAll('.cat-content').forEach(content => {
        content.classList.remove('open');
        content.previousElementSibling.classList.remove('open');
    });
    
    // Update button text
    const btn = document.getElementById('toggleAllBtn');
    if (btn) btn.innerHTML = '‚ñº Expand All';
    state.allExpanded = false;
}

function toggleAllCategories() {
    if (state.allExpanded) {
        closeAllCategories();
    } else {
        openAllCategories();
    }
}

// ==================== PREVIEW ====================
function buildPreview() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const salesmanKey = document.getElementById('salesman').value;
    const salesmanInfo = salesmanKey ? SALESMEN[salesmanKey] : null;
    const tender = document.getElementById('tenderNum').value;
    const hideSubPrices = document.getElementById('hideSubPrices').checked;
    const quoteTitle = document.getElementById('quoteTitle').value;
    
    // Set quotation title in preview
    document.getElementById('prevQuoteTitle').textContent = quoteTitle;
    
    // Quote info with salesman details
    let salesmanHtml = '';
    if (salesmanInfo) {
        salesmanHtml = `
            Salesman: ${salesmanInfo.name}<br>
            ‚úâ ${salesmanInfo.email}<br>
            ‚òé ${salesmanInfo.phone}<br>
        `;
    }
    
    document.getElementById('prevQuoteInfo').innerHTML = `
        Quote #: ${document.getElementById('quoteNum').value}<br>
        Date: ${document.getElementById('quoteDate').value}<br>
        Validity: ${document.getElementById('validity').value}<br>
        ${salesmanHtml}
        Payment: ${document.getElementById('payTerms').value}<br>
        Delivery Terms: ${document.getElementById('deliveryTerms').value}<br>
        Delivery Timeline: ${getDeliveryTimeline()}
    `;
    
    document.getElementById('prevCustInfo').innerHTML = `
        ${document.getElementById('custCompany').value || '-'}<br>
        ${document.getElementById('custName').value || '-'}<br>
        ${document.getElementById('custEmail').value || '-'}<br>
        ${document.getElementById('custPhone').value || '-'}<br>
        ${tender ? 'Tender: ' + tender + '<br>' : ''}
        ${document.getElementById('custAddr').value || ''}
    `;
    
    // Calculate totals first (per boat then multiply)
    let optionsPerBoat = 0;
    Object.values(state.items).forEach(cat => {
        Object.values(cat).forEach(item => {
            if (item.price && item.qty && !item.isTBD) {
                optionsPerBoat += item.price * item.qty;
            }
        });
    });
    
    const boatTotal = boat.price * boatQty;
    const optionsTotal = optionsPerBoat * boatQty;
    const subtotal = boatTotal + optionsTotal;
    const discountPct = parseFloat(document.getElementById('discount').value) || 0;
    const discount = subtotal * (discountPct / 100);
    const total = subtotal - discount;
    
    // Items table
    let itemsHtml = '';
    if (hideSubPrices) {
        // Show items but hide individual prices - only show total at the end
        itemsHtml = `<tr><td><strong>${BOATS[state.boatType].name} - ${boat.size}</strong></td><td>${boatQty}</td><td class="right">-</td><td class="right">-</td></tr>`;
        
        Object.entries(state.items).forEach(([cat, items]) => {
            Object.values(items).forEach(item => {
                // Skip "None" selections (itemIdx === -1)
                if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                    const totalQty = item.qty * boatQty;
                    itemsHtml += `<tr><td>${item.name}</td><td>${totalQty}</td><td class="right">-</td><td class="right">-</td></tr>`;
                }
            });
        });
    } else {
        // Show full details with prices
        itemsHtml = `<tr><td><strong>${BOATS[state.boatType].name} - ${boat.size}</strong></td><td>${boatQty}</td><td class="right">${fmtPrice(boat.price)}</td><td class="right">${fmtPrice(boatTotal)}</td></tr>`;
        
        Object.entries(state.items).forEach(([cat, items]) => {
            Object.values(items).forEach(item => {
                // Skip "None" selections (itemIdx === -1)
                if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                    const totalQty = item.qty * boatQty;
                    const unitPrice = item.isTBD ? 'TBD' : fmtPrice(item.price);
                    const itemTotal = item.isTBD ? 'TBD' : fmtPrice(item.price * totalQty);
                    itemsHtml += `<tr><td>${item.name}</td><td>${totalQty}</td><td class="right">${unitPrice}</td><td class="right">${itemTotal}</td></tr>`;
                }
            });
        });
    }
    
    document.getElementById('prevItems').innerHTML = itemsHtml;
    
    // Totals
    if (hideSubPrices) {
        document.getElementById('prevTotals').innerHTML = `
            ${discountPct > 0 ? `<div>Discount: ${discountPct}%</div>` : ''}
            <div class="grand">TOTAL: ${fmtPrice(total)}</div>
        `;
    } else {
        document.getElementById('prevTotals').innerHTML = `
            <div>Subtotal: ${fmtPrice(subtotal)}</div>
            ${discountPct > 0 ? `<div>Discount (${discountPct}%): -${fmtPrice(discount)}</div>` : ''}
            <div class="grand">TOTAL: ${fmtPrice(total)}</div>
        `;
    }
    
    // Notes
    const notes = document.getElementById('quoteNotes').value;
    if (notes) {
        document.getElementById('prevNotes').style.display = 'block';
        document.getElementById('prevNotesText').textContent = notes;
    } else {
        document.getElementById('prevNotes').style.display = 'none';
    }
}

// ==================== PDF CONFIGURATION ====================
// Base URL for static assets - change this to your Vercel deployment URL
const PDF_CONFIG = {
    // Set this to your Vercel URL when deployed, e.g., 'https://your-app.vercel.app'
    // For local testing, use relative paths or a local server
    baseUrl: '', // Leave empty for relative paths
    
    // Static PDF paths (relative to baseUrl)
    staticPdfs: {
        page1Template: '/assets/pdf/page1_template.pdf',
        companyPresentation: '/assets/pdf/company_presentation.pdf',
        termsConditions: '/assets/pdf/terms_conditions.pdf'
    },
    
    // Technical specs folder
    specsFolder: '/specs/',
    
    // Image assets
    images: {
        asusLogo: '/assets/images/asis_logo.jpg',
        asisDiamond: '/assets/images/asis_diamond.jpg',
        shield: '/assets/images/shield.png',
        arrow: '/assets/images/arrow.png',
        stamp: '/assets/images/stamp.png'
    }
};

// Helper function to get spec PDF filename based on boat type and size
function getSpecPdfFilename() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const sizeStr = boat.size.replace('.', '_').replace('M', '').toLowerCase();
    
    if (state.boatType === 'aluminum') {
        return `alu_${sizeStr}.pdf`;
    } else if (state.boatType === 'fiberglass') {
        return `grp_${sizeStr}.pdf`;
    } else if (state.boatType === 'inflatable') {
        return `hdib_${sizeStr}.pdf`;
    }
    return null;
}

// ==================== EXPORT ====================
async function downloadPDF() {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    
    // Show loading indicator
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Generating PDF...';
    btn.disabled = true;
    
    try {
        // Gather all form data
        const formData = gatherFormData();
        
        // Create the main PDF document
        const pdfDoc = await PDFDocument.create();
        
        // Embed fonts
        const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
        const timesRoman = await pdfDoc.embedFont(StandardFonts.TimesRoman);
        const timesItalic = await pdfDoc.embedFont(StandardFonts.TimesRomanItalic);
        
        const fonts = { helvetica, helveticaBold, timesRoman, timesItalic };
        
        // Page 1: Cover Page
        await generateCoverPage(pdfDoc, fonts, formData);
        
        // Page 2: Company Presentation (static PDF)
        await embedStaticPdf(pdfDoc, PDF_CONFIG.staticPdfs.companyPresentation, 'Company Presentation');
        
        // Page 3: Quotation Details
        await generateQuotationPage(pdfDoc, fonts, formData);
        
        // Page 4: Annex (accessories list) - may be multiple pages
        await generateAnnexPages(pdfDoc, fonts, formData);
        
        // Page 5: Technical Specifications (boat-specific PDF)
        const specFilename = getSpecPdfFilename();
        if (specFilename) {
            await embedStaticPdf(pdfDoc, PDF_CONFIG.specsFolder + specFilename, 'Technical Specifications');
        }
        
        // Page 6: Terms & Conditions (static PDF)
        await embedStaticPdf(pdfDoc, PDF_CONFIG.staticPdfs.termsConditions, 'Terms & Conditions');
        
        // Save and download
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${formData.quoteNum}.pdf`;
        link.click();
        URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('PDF Generation Error:', error);
        alert('Error generating PDF. Some static PDFs may not be available. Check console for details.\n\nGenerating simplified PDF...');
        
        // Fallback: generate simplified PDF without static pages
        await generateSimplifiedPDF();
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// Gather all form data into a single object
function gatherFormData() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const salesmanKey = document.getElementById('salesman').value;
    const salesmanInfo = salesmanKey ? SALESMEN[salesmanKey] : null;
    const hideSubPrices = document.getElementById('hideSubPrices').checked;
    
    // Calculate category totals
    let engineTotal = 0;
    let asiaAccessoriesTotal = 0;
    let electronicsTotal = 0;
    let engineName = '';
    
    const groups = CATEGORY_GROUPS[state.boatType] || [];
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                const itemTotal = item.isTBD ? 0 : (item.price * item.qty);
                
                if (cat === 'Propulsion / Engine') {
                    engineTotal += itemTotal;
                    engineName = item.name;
                } else {
                    // Check which group this category belongs to
                    for (const group of groups) {
                        if (group.categories && group.categories.includes(cat)) {
                            if (group.name === 'ASIS Accessories') {
                                asiaAccessoriesTotal += itemTotal;
                            } else if (group.name === 'Electronics & Communication') {
                                electronicsTotal += itemTotal;
                            }
                            break;
                        }
                        if (group.subgroups) {
                            for (const subgroup of group.subgroups) {
                                if (subgroup.categories && subgroup.categories.includes(cat)) {
                                    if (group.name === 'ASIS Accessories') {
                                        asiaAccessoriesTotal += itemTotal;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        });
    });
    
    // Calculate totals
    const boatTotal = boat.price * boatQty;
    let optionsPerBoat = 0;
    Object.values(state.items).forEach(cat => {
        Object.values(cat).forEach(item => {
            if (item.price && item.qty && !item.isTBD && item.itemIdx !== -1) {
                optionsPerBoat += item.price * item.qty;
            }
        });
    });
    const optionsTotal = optionsPerBoat * boatQty;
    const subtotal = boatTotal + optionsTotal;
    const discountPct = parseFloat(document.getElementById('discount').value) || 0;
    const discount = subtotal * (discountPct / 100);
    const total = subtotal - discount;
    
    return {
        // Quote info
        quoteNum: document.getElementById('quoteNum').value || 'Q-000',
        quoteDate: document.getElementById('quoteDate').value || new Date().toLocaleDateString(),
        quoteTitle: document.getElementById('quoteTitle').value || `${boat.size} ${BOATS[state.boatType].name}`,
        tender: document.getElementById('tenderNum').value || '',
        
        // Customer info
        custCompany: document.getElementById('custCompany').value || '',
        custContact: document.getElementById('custName').value || '',
        custPhone: document.getElementById('custPhone').value || '',
        custEmail: document.getElementById('custEmail').value || '',
        custAddress: document.getElementById('custAddr').value || '',
        
        // Salesman info
        salesmanInfo,
        
        // Boat info
        boatType: state.boatType,
        boatTypeName: BOATS[state.boatType].name,
        boatSize: boat.size,
        boatPrice: boat.price,
        boatQty,
        boatTotal,
        
        // Engine
        engineName,
        engineTotal: engineTotal * boatQty,
        
        // Category totals
        asiaAccessoriesTotal: asiaAccessoriesTotal * boatQty,
        electronicsTotal: electronicsTotal * boatQty,
        
        // Overall totals
        optionsTotal,
        subtotal,
        discountPct,
        discount,
        total,
        
        // Currency
        currency: state.currency,
        
        // Options
        hideSubPrices,
        
        // Terms
        paymentTerms: document.getElementById('payTerms').value || '',
        deliveryTimeline: getDeliveryTimeline(),
        deliveryTerms: document.getElementById('deliveryTerms').value || '',
        validity: document.getElementById('validity').value || '',
        notes: document.getElementById('quoteNotes').value || '',
        
        // Items for annex
        items: state.items,
        categoryGroups: CATEGORY_GROUPS[state.boatType] || []
    };
}

// ==================== PAGE 1: COVER PAGE (Using Template) ====================
async function generateCoverPage(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    
    try {
        // Try to load the page 1 template
        const templateUrl = PDF_CONFIG.baseUrl + PDF_CONFIG.staticPdfs.page1Template;
        const response = await fetch(templateUrl);
        
        if (!response.ok) {
            console.warn('Page 1 template not found, generating from scratch');
            await generateCoverPageFallback(pdfDoc, fonts, formData);
            return;
        }
        
        const templateBytes = await response.arrayBuffer();
        const templatePdf = await PDFLib.PDFDocument.load(templateBytes);
        const [templatePage] = await pdfDoc.copyPages(templatePdf, [0]);
        pdfDoc.addPage(templatePage);
        
        // Get the page we just added (last page)
        const page = pdfDoc.getPages()[pdfDoc.getPageCount() - 1];
        const { width, height } = page.getSize();
        
        // Colors
        const asiaRed = rgb(0.722, 0.196, 0.251); // #B83240
        const darkGray = rgb(0.3, 0.3, 0.3);
        const black = rgb(0, 0, 0);
        
        // === ADD DYNAMIC TEXT ON TOP OF TEMPLATE ===
        // Page 1 coordinates - adjust each field individually
        // To find these lines: search for "PAGE1_FIELD:" in your editor
        
        // PAGE1_FIELD: Quote Number (right-aligned, right edge position)
        const quoteNumWidth = fonts.helveticaBold.widthOfTextAtSize(formData.quoteNum, 18);
        page.drawText(formData.quoteNum, {
            x: 444 - quoteNumWidth,  // LINE ~2567: Adjust X (right edge at 444)
            y: 586,                   // LINE ~2568: Adjust Y
            size: 18,
            font: fonts.helveticaBold,
            color: asiaRed
        });
        
        // PAGE1_FIELD: Title and Tender - Dynamic positioning
        // Stack from bottom (Y=436) upward based on what's present
        const titleLines = splitTextToLines(formData.quoteTitle, 45);
        const hasTitle2 = titleLines[1] ? true : false;
        const hasTender = formData.tender ? true : false;
        
        // Calculate Y positions based on what elements exist
        let title1Y, title2Y, tenderY;
        
        if (hasTitle2 && hasTender) {
            // All three present: stack normally
            title1Y = 480;
            title2Y = 456;
            tenderY = 436;
        } else if (!hasTitle2 && hasTender) {
            // No title line 2: title1 moves to title2 position
            title1Y = 456;
            tenderY = 436;
        } else if (hasTitle2 && !hasTender) {
            // No tender: both titles move down
            title1Y = 456;
            title2Y = 436;
        } else {
            // Only title line 1: moves to bottom position
            title1Y = 436;
        }
        
        // Draw Title Line 1
        page.drawText(titleLines[0] || '', {
            x: 73,
            y: title1Y,
            size: 18,
            font: fonts.helveticaBold,
            color: black
        });
        
        // Draw Title Line 2 (if exists)
        if (hasTitle2) {
            page.drawText(titleLines[1], {
                x: 73,
                y: title2Y,
                size: 18,
                font: fonts.helveticaBold,
                color: black
            });
        }
        
        // Draw Tender Number (if exists)
        if (hasTender) {
            page.drawText('Tender No. ' + formData.tender, {
                x: 73,
                y: tenderY,
                size: 11,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Customer Company
        if (formData.custCompany) {
            page.drawText(formData.custCompany, {
                x: 83,   // LINE ~2609: Adjust X
                y: 388,  // LINE ~2610: Adjust Y
                size: 16,
                font: fonts.helveticaBold,
                color: black
            });
        }
        
        // PAGE1_FIELD: Customer Contact
        if (formData.custContact) {
            page.drawText(formData.custContact, {
                x: 83,   // LINE ~2620: Adjust X
                y: 367,  // LINE ~2621: Adjust Y
                size: 14,
                font: fonts.helveticaBold,
                color: black
            });
        }
        
        // PAGE1_FIELD: Customer Address
        if (formData.custAddress) {
            page.drawText(formData.custAddress, {
                x: 100,   // LINE ~2632: Adjust X
                y: 346,  // LINE ~2633: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Customer Phone
        if (formData.custPhone) {
            page.drawText(formData.custPhone, {
                x: 100,   // LINE ~2643: Adjust X
                y: 329,  // LINE ~2644: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Customer Email
        if (formData.custEmail) {
            page.drawText(formData.custEmail, {
                x: 100,   // LINE ~2654: Adjust X
                y: 312,  // LINE ~2655: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Salesman Name
        if (formData.salesmanInfo) {
            page.drawText(formData.salesmanInfo.name.toUpperCase(), {
                x: 82,   // LINE ~2666: Adjust X
                y: 165,  // LINE ~2667: Adjust Y
                size: 14,
                font: fonts.helveticaBold,
                color: black
            });
            
            // PAGE1_FIELD: Salesman Email
            page.drawText(formData.salesmanInfo.email, {
                x: 100,   // LINE ~2676: Adjust X
                y: 149,  // LINE ~2677: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
            
            // PAGE1_FIELD: Salesman Phone
            page.drawText(formData.salesmanInfo.phone, {
                x: 100,   // LINE ~2686: Adjust X
                y: 131,  // LINE ~2687: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        console.log('Cover page generated from template');
        
    } catch (error) {
        console.warn('Error loading template, using fallback:', error);
        await generateCoverPageFallback(pdfDoc, fonts, formData);
    }
}

// Fallback cover page if template is not available
async function generateCoverPageFallback(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    const page = pdfDoc.addPage([612, 792]); // US Letter size
    const { width, height } = page.getSize();
    
    // Colors
    const asiaRed = rgb(0.722, 0.196, 0.251);
    const darkGray = rgb(0.4, 0.4, 0.4);
    const black = rgb(0, 0, 0);
    
    // Header - ASIS text placeholder
    page.drawText('ASIS BOATS', {
        x: 220,
        y: height - 60,
        size: 28,
        font: fonts.helveticaBold,
        color: asiaRed
    });
    page.drawText('ACES OF THE SEA', {
        x: 225,
        y: height - 80,
        size: 10,
        font: fonts.helvetica,
        color: darkGray
    });
    
    // "ADVANCE MARITIME SOLUTION" + Quote Number
    page.drawText('ADVANCE MARITIME SOLUTION', {
        x: 250,
        y: height - 180,
        size: 14,
        font: fonts.helveticaBold,
        color: black
    });
    page.drawText(formData.quoteNum, {
        x: 250,
        y: height - 205,
        size: 20,
        font: fonts.helveticaBold,
        color: asiaRed
    });
    
    // Quotation Title
    const titleLines = splitTextToLines(formData.quoteTitle, 50);
    let yPos = height - 320;
    titleLines.forEach((line, i) => {
        page.drawText(line, {
            x: 50,
            y: yPos - (i * 25),
            size: 18,
            font: fonts.helveticaBold,
            color: black
        });
    });
    yPos -= (titleLines.length * 25) + 10;
    
    // Tender
    if (formData.tender) {
        page.drawText('Tender No. ' + formData.tender, {
            x: 50,
            y: yPos,
            size: 11,
            font: fonts.helvetica,
            color: darkGray
        });
        yPos -= 30;
    }
    
    // "Proposed To:" section
    yPos -= 20;
    page.drawText('Proposed To:', {
        x: 50,
        y: yPos,
        size: 11,
        font: fonts.helvetica,
        color: darkGray
    });
    yPos -= 25;
    
    if (formData.custCompany) {
        page.drawText(formData.custCompany, { x: 50, y: yPos, size: 16, font: fonts.helveticaBold, color: black });
        yPos -= 22;
    }
    if (formData.custContact) {
        page.drawText(formData.custContact, { x: 50, y: yPos, size: 14, font: fonts.helveticaBold, color: black });
        yPos -= 22;
    }
    if (formData.custAddress) {
        page.drawText(formData.custAddress, { x: 50, y: yPos, size: 10, font: fonts.helvetica, color: darkGray });
        yPos -= 18;
    }
    if (formData.custPhone) {
        page.drawText(formData.custPhone, { x: 50, y: yPos, size: 10, font: fonts.helvetica, color: darkGray });
        yPos -= 18;
    }
    if (formData.custEmail) {
        page.drawText(formData.custEmail, { x: 50, y: yPos, size: 10, font: fonts.helvetica, color: darkGray });
    }
    
    // "Prepared" section
    let prepY = 180;
    page.drawText('Prepared', { x: 50, y: prepY, size: 11, font: fonts.helvetica, color: darkGray });
    prepY -= 25;
    
    if (formData.salesmanInfo) {
        page.drawText(formData.salesmanInfo.name.toUpperCase(), { x: 50, y: prepY, size: 14, font: fonts.helveticaBold, color: black });
        prepY -= 18;
        page.drawText(formData.salesmanInfo.email, { x: 50, y: prepY, size: 10, font: fonts.helvetica, color: darkGray });
        prepY -= 16;
        page.drawText(formData.salesmanInfo.phone, { x: 50, y: prepY, size: 10, font: fonts.helvetica, color: darkGray });
    }
    
    // Footer
    page.drawText('ASIS Boats L.L.C, Jebel Ali Industrial Area 2, Dubai, UAE | Tel: +971 880 4441 | www.asisboats.com', {
        x: 80,
        y: 30,
        size: 8,
        font: fonts.helvetica,
        color: darkGray
    });
}

// ==================== PAGE 3: QUOTATION DETAILS (Using Template) ====================
async function generateQuotationPage(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    
    // Colors
    const asiaRed = rgb(0.722, 0.196, 0.251);
    const darkGray = rgb(0.4, 0.4, 0.4);
    const black = rgb(0, 0, 0);
    const lightGray = rgb(0.9, 0.9, 0.9);
    const white = rgb(1, 1, 1);
    
    // Try to load the page 3 template
    let page;
    let height = 792;
    
    try {
        const templateUrl = PDF_CONFIG.baseUrl + '/assets/pdf/page3_template.pdf';
        const response = await fetch(templateUrl);
        
        if (response.ok) {
            const templateBytes = await response.arrayBuffer();
            const templatePdf = await PDFLib.PDFDocument.load(templateBytes);
            const [templatePage] = await pdfDoc.copyPages(templatePdf, [0]);
            pdfDoc.addPage(templatePage);
            page = pdfDoc.getPages()[pdfDoc.getPageCount() - 1];
            console.log('Page 3 template loaded successfully');
        } else {
            page = pdfDoc.addPage([612, 792]);
            // Draw header manually if no template
            drawDiamond(page, 306, height - 25, 12, asiaRed);
            page.drawText('QUOTATION', { x: 200, y: height - 90, size: 28, font: fonts.timesItalic, color: black });
            // Draw footer
            page.drawLine({ start: { x: 180, y: 50 }, end: { x: 415, y: 50 }, thickness: 0.5, color: darkGray });
            page.drawText('www.asisboats.com', { x: 255, y: 35, size: 10, font: fonts.helveticaBold, color: black });
        }
    } catch (e) {
        page = pdfDoc.addPage([612, 792]);
        drawDiamond(page, 306, height - 25, 12, asiaRed);
        page.drawText('QUOTATION', { x: 200, y: height - 90, size: 28, font: fonts.timesItalic, color: black });
        page.drawLine({ start: { x: 180, y: 50 }, end: { x: 415, y: 50 }, thickness: 0.5, color: darkGray });
        page.drawText('www.asisboats.com', { x: 255, y: 35, size: 10, font: fonts.helveticaBold, color: black });
    }
    
    // Currency symbol/code for display
    const currencyDisplay = formData.currency || 'USD';
    
    // === DYNAMIC CONTENT ===
    
    // Ref. No. and Date line
    let y = height - 130;
    page.drawText('Ref. No.', { x: 60, y, size: 10, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.quoteNum, { x: 110, y, size: 11, font: fonts.helveticaBold, color: black });
    // Date - right-aligned to content area (last digit at ~550)
    const dateText = formData.quoteDate;
    const dateWidth = fonts.helveticaBold.widthOfTextAtSize(dateText, 11);
    page.drawText('Date:', { x: 470, y, size: 10, font: fonts.helvetica, color: darkGray });
    page.drawText(dateText, { x: 550 - dateWidth, y, size: 11, font: fonts.helveticaBold, color: black });
    
    // Horizontal line under Ref/Date
    y -= 15;
    page.drawLine({ start: { x: 60, y }, end: { x: 552, y }, thickness: 0.5, color: lightGray });
    
    // TO: section - styled with left border accent
    y -= 25;
    page.drawRectangle({ x: 60, y: y - 6, width: 4, height: 16, color: asiaRed });
    page.drawText('TO:', { x: 68, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    
    // FROM: section - styled with left border accent
    page.drawRectangle({ x: 310, y: y - 6, width: 4, height: 16, color: asiaRed });
    page.drawText('FROM:', { x: 318, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    
    // Customer and Company details
    y -= 25;
    const leftCol = 60;
    const leftValCol = 140;
    const rightCol = 310;
    const rightValCol = 380;
    
    page.drawText('Company /Dep.:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custCompany || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    page.drawText('Company:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText('ASIS BOATS LLC, DUBAI UAE', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    
    y -= 18;
    page.drawText('Point of Contact:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custContact || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    page.drawText('Telephone:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText('+971 (0)4 880 4441', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    
    y -= 18;
    page.drawText('Contact #:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custPhone || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    page.drawText('Sales Person:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.salesmanInfo?.name || '-', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    
    y -= 18;
    page.drawText('Email:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custEmail || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    page.drawText('Contact #:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.salesmanInfo?.phone || '-', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    
    y -= 18;
    page.drawText('Address:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    const addrLines = splitTextToLines(formData.custAddress || '-', 35);
    addrLines.forEach((line, i) => {
        page.drawText(line, { x: leftValCol, y: y - (i * 12), size: 9, font: fonts.helvetica, color: black });
    });
    page.drawText('Email:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.salesmanInfo?.email || '-', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    
    // Description table header - same style as TO/FROM with left accent
    y -= 35; // Reduced from 50
    const tableHeaderHeight = 20;
    // Light gray background for header row
    page.drawRectangle({ x: 60, y: y - 5, width: 492, height: tableHeaderHeight, color: rgb(0.95, 0.95, 0.95) });
    // Red accent bar on left
    page.drawRectangle({ x: 60, y: y - 5, width: 4, height: tableHeaderHeight, color: asiaRed });
    // Header text - vertically centered
    const headerTextY = y + 2;
    page.drawText('Description', { x: 70, y: headerTextY, size: 10, font: fonts.helveticaBold, color: black });
    page.drawText('Qty.', { x: 420, y: headerTextY, size: 10, font: fonts.helveticaBold, color: black });
    if (!formData.hideSubPrices) {
        page.drawText('Price', { x: 480, y: headerTextY, size: 10, font: fonts.helveticaBold, color: black });
    }
    
    // Table rows - reduced gap after header
    y -= 22; // Reduced from 30
    
    // Row 1: Boat Type and Size (format: "ASIS 9.5M Aluminium RHIB")
    const boatTypeLabels = {
        'aluminum': 'Aluminium RHIB',
        'fiberglass': 'GRP RHIB',
        'inflatable': 'HDIB'
    };
    const boatDescription = `ASIS ${formData.boatSize} ${boatTypeLabels[formData.boatType] || formData.boatTypeName}`;
    page.drawText(boatDescription, { x: 70, y, size: 10, font: fonts.helveticaBold, color: black });
    page.drawText(formData.boatQty.toString(), { x: 425, y, size: 10, font: fonts.helvetica, color: black });
    if (!formData.hideSubPrices) {
        page.drawText(formatNumber(formData.boatPrice), { x: 470, y, size: 10, font: fonts.helvetica, color: black });
    }
    
    // Dotted line UNDER boat type row (removed the first dotted line above it)
    y -= 15;
    drawDottedLine(page, 70, y, 542, y, lightGray);
    
    // Row 2: Engine (BOLD) - with line wrapping for long names
    y -= 15;
    let engineLinesCount = 1;
    if (formData.engineName) {
        const engineText = `- ${formData.engineName}`;
        const engineLines = splitTextToLines(engineText, 55);
        engineLinesCount = engineLines.length;
        
        engineLines.forEach((line, i) => {
            page.drawText(line, { x: 70, y: y - (i * 12), size: 9, font: fonts.helveticaBold, color: black });
        });
        
        if (!formData.hideSubPrices && formData.engineTotal > 0) {
            page.drawText(formatNumber(formData.engineTotal / formData.boatQty), { x: 470, y, size: 9, font: fonts.helvetica, color: black });
        }
        
        if (engineLines.length > 1) {
            y -= (engineLines.length - 1) * 12;
        }
    }
    
    // Row 3: ASIS ACCESSORIES
    y -= 20;
    page.drawText('- ASIS ACCESSORIES - (ANNEX-1)', { x: 70, y, size: 9, font: fonts.helvetica, color: black });
    if (!formData.hideSubPrices && formData.asiaAccessoriesTotal > 0) {
        page.drawText(formatNumber(formData.asiaAccessoriesTotal / formData.boatQty), { x: 470, y, size: 9, font: fonts.helvetica, color: black });
    }
    
    // Row 4: ELECTRONIC AND COMMUNICATION
    y -= 20;
    page.drawText('- ELECTRONIC AND COMMUNICATION - (ANNEX-2)', { x: 70, y, size: 9, font: fonts.helvetica, color: black });
    if (!formData.hideSubPrices && formData.electronicsTotal > 0) {
        page.drawText(formatNumber(formData.electronicsTotal / formData.boatQty), { x: 470, y, size: 9, font: fonts.helvetica, color: black });
    }
    
    // Row 5: TECHNICAL SPECIFICATIONS
    y -= 20;
    page.drawText('- TECHNICAL SPECIFICATIONS - (ANNEX-3)', { x: 70, y, size: 9, font: fonts.helvetica, color: black });
    
    // Dotted line after last description item
    y -= 15;
    drawDottedLine(page, 70, y, 542, y, lightGray);
    
    // === NOTE AND TOTAL BOX (shorter height - about half) ===
    y -= 20;
    const noteBoxY = y;
    const noteBoxHeight = 40; // Reduced from 70
    page.drawRectangle({ x: 60, y: noteBoxY - noteBoxHeight + 5, width: 492, height: noteBoxHeight, borderColor: black, borderWidth: 1 });
    
    // Note
    page.drawText('Note:', { x: 70, y: noteBoxY - 5, size: 9, font: fonts.helveticaBold, color: asiaRed });
    if (formData.notes) {
        const noteLines = splitTextToLines(formData.notes, 40);
        noteLines.slice(0, 2).forEach((line, i) => {
            page.drawText(line, { x: 100, y: noteBoxY - 5 - (i * 12), size: 9, font: fonts.helvetica, color: black });
        });
    }
    
    // Total with currency
    page.drawText('TOTAL', { x: 410, y: noteBoxY - 18, size: 11, font: fonts.helveticaBold, color: black });
    page.drawText(`${currencyDisplay} ${formatNumber(formData.total)}`, { x: 450, y: noteBoxY - 18, size: 14, font: fonts.helveticaBold, color: black });
    
    // === TERMS SECTION ===
    y = noteBoxY - noteBoxHeight - 15;
    const termY = y;
    const termLabelX = 60;
    const termValueX = 155;
    const termLineEnd = 400; // Shortened dotted lines
    const lineHeight = 18;
    
    page.drawText('Term of Payment', { x: termLabelX, y: termY, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.paymentTerms}`, { x: termValueX, y: termY, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - 3, termLineEnd, termY - 3, lightGray);
    
    page.drawText('Delivery Schedule', { x: termLabelX, y: termY - lineHeight, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.deliveryTimeline}`, { x: termValueX, y: termY - lineHeight, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight - 3, termLineEnd, termY - lineHeight - 3, lightGray);
    
    page.drawText('Delivery Terms', { x: termLabelX, y: termY - lineHeight * 2, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.deliveryTerms}`, { x: termValueX, y: termY - lineHeight * 2, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 2 - 3, termLineEnd, termY - lineHeight * 2 - 3, lightGray);
    
    page.drawText('Warranty', { x: termLabelX, y: termY - lineHeight * 3, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(':  Click here to read full warranty', { x: termValueX, y: termY - lineHeight * 3, size: 9, font: fonts.helveticaBold, color: asiaRed });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 3 - 3, termLineEnd, termY - lineHeight * 3 - 3, lightGray);
    
    page.drawText('Validity', { x: termLabelX, y: termY - lineHeight * 4, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.validity}`, { x: termValueX, y: termY - lineHeight * 4, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 4 - 3, termLineEnd, termY - lineHeight * 4 - 3, lightGray);
    
    page.drawText('Country of Origin', { x: termLabelX, y: termY - lineHeight * 5, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(':  United Arab Emirates', { x: termValueX, y: termY - lineHeight * 5, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 5 - 3, termLineEnd, termY - lineHeight * 5 - 3, lightGray);
    
    // === SIGNATURE SECTION (after Country of Origin) ===
    const sigY = termY - lineHeight * 6 - 10;
    
    // Left side: "For ASIS Boats L.L.C," and salesman name
    page.drawText('For ', { x: termLabelX, y: sigY, size: 10, font: fonts.helvetica, color: black });
    page.drawText('ASIS Boats L.L.C', { x: termLabelX + 20, y: sigY, size: 10, font: fonts.helveticaBold, color: black });
    page.drawText(',', { x: termLabelX + 105, y: sigY, size: 10, font: fonts.helvetica, color: black });
    
    // Salesman name below
    page.drawText(formData.salesmanInfo?.name || '', { x: termLabelX, y: sigY - 18, size: 10, font: fonts.helveticaBold, color: black });
    
    // Right side: SIGN AND STAMP box
    const stampX = 420;
    const stampBoxHeight = 60;
    page.drawRectangle({ x: stampX, y: sigY - stampBoxHeight + 15, width: 125, height: stampBoxHeight, borderColor: black, borderWidth: 0.5 });
    // Text at bottom of rectangle, smaller font
    page.drawText('SIGN AND STAMP', { x: stampX + 28, y: sigY - stampBoxHeight + 20, size: 7, font: fonts.helvetica, color: darkGray });
}

// ==================== PAGE 4: ANNEX PAGES ====================
async function generateAnnexPages(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    
    // Colors
    const asiaRed = rgb(0.722, 0.196, 0.251);
    const darkGray = rgb(0.4, 0.4, 0.4);
    const black = rgb(0, 0, 0);
    
    // Collect items by annex category
    const annexItems = {
        'ASIS ACCESSORIES': [],
        'ELECTRONICS & COMMUNICATION': []
    };
    
    const groups = formData.categoryGroups;
    
    Object.entries(formData.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                // Skip engine - it's shown separately
                if (cat === 'Propulsion / Engine') return;
                
                // Determine which annex this belongs to
                for (const group of groups) {
                    if (group.categories && group.categories.includes(cat)) {
                        if (group.name === 'ASIS Accessories') {
                            annexItems['ASIS ACCESSORIES'].push({ name: item.name, qty: item.qty * formData.boatQty });
                        } else if (group.name === 'Electronics & Communication') {
                            annexItems['ELECTRONICS & COMMUNICATION'].push({ name: item.name, qty: item.qty * formData.boatQty });
                        }
                        break;
                    }
                    if (group.subgroups) {
                        for (const subgroup of group.subgroups) {
                            if (subgroup.categories && subgroup.categories.includes(cat)) {
                                if (group.name === 'ASIS Accessories') {
                                    annexItems['ASIS ACCESSORIES'].push({ name: item.name, qty: item.qty * formData.boatQty });
                                }
                                break;
                            }
                        }
                    }
                }
            }
        });
    });
    
    // Try to load annex template
    let templateAvailable = false;
    let height = STANDARD_PAGE_HEIGHT;  // US Letter height (792)
    try {
        const templateUrl = PDF_CONFIG.baseUrl + 'assets/pdf/annex_template.pdf';
        const response = await fetch(templateUrl);
        if (response.ok) {
            templateAvailable = true;
        }
    } catch (e) {
        console.warn('Annex template not found, using blank page');
    }
    
    // Helper function to add a new annex page (scaled to Letter size)
    async function addAnnexPage() {
        let page;
        if (templateAvailable) {
            // Copy template for each new page
            const templateUrl = PDF_CONFIG.baseUrl + 'assets/pdf/annex_template.pdf';
            const response = await fetch(templateUrl);
            const templateBytes = await response.arrayBuffer();
            const templatePdf = await PDFLib.PDFDocument.load(templateBytes);
            const [newPage] = await pdfDoc.copyPages(templatePdf, [0]);
            
            // Scale to standard Letter size if needed
            const { width: origWidth, height: origHeight } = newPage.getSize();
            if (Math.abs(origWidth - STANDARD_PAGE_WIDTH) > 1 || Math.abs(origHeight - STANDARD_PAGE_HEIGHT) > 1) {
                const scaleX = STANDARD_PAGE_WIDTH / origWidth;
                const scaleY = STANDARD_PAGE_HEIGHT / origHeight;
                const scale = Math.min(scaleX, scaleY);
                
                newPage.setSize(STANDARD_PAGE_WIDTH, STANDARD_PAGE_HEIGHT);
                newPage.scaleContent(scale, scale);
                
                // Center content if aspect ratios differ
                if (scaleX !== scaleY) {
                    const newWidth = origWidth * scale;
                    const newHeight = origHeight * scale;
                    const xOffset = (STANDARD_PAGE_WIDTH - newWidth) / 2;
                    const yOffset = (STANDARD_PAGE_HEIGHT - newHeight) / 2;
                    newPage.translateContent(xOffset, yOffset);
                }
                console.log(`Scaled annex page from ${origWidth}x${origHeight} to ${STANDARD_PAGE_WIDTH}x${STANDARD_PAGE_HEIGHT}`);
            }
            
            pdfDoc.addPage(newPage);
            page = pdfDoc.getPages()[pdfDoc.getPageCount() - 1];
        } else {
            page = pdfDoc.addPage([STANDARD_PAGE_WIDTH, STANDARD_PAGE_HEIGHT]); // US Letter
            // Draw header manually if no template
            drawDiamond(page, 306, height - 25, 12, asiaRed);
            page.drawText('PERFORMANCE - QUALITY - DESIGN - SAFETY', { x: 178, y: height - 50, size: 10, font: fonts.helveticaBold, color: black });
        }
        return page;
    }
    
    // Generate first annex page
    let page = await addAnnexPage();
    let { width } = page.getSize();
    height = STANDARD_PAGE_HEIGHT;  // US Letter height
    let y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page (moved up from -130)
    
    // ANNEX 1: ASIS ACCESSORIES
    page.drawText('ANNEX 1:', { x: 60, y, size: 12, font: fonts.helveticaBold, color: black });
    y -= 20;
    page.drawText('ASIS ACCESSORIES', { x: 60, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    y -= 25;
    
    if (annexItems['ASIS ACCESSORIES'].length === 0) {
        page.drawText('- No accessories selected', { x: 70, y, size: 10, font: fonts.helvetica, color: darkGray });
        y -= 20;
    } else {
        for (const item of annexItems['ASIS ACCESSORIES']) {
            if (y < 100) {
                // Add new page using template
                page = await addAnnexPage();
                y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page
            }
            
            const itemText = `- ${item.name} (Qty: ${item.qty})`;
            page.drawText(truncateText(itemText, 80), { x: 70, y, size: 10, font: fonts.helvetica, color: black });
            y -= 18;
        }
    }
    
    // ANNEX 2: ELECTRONICS & COMMUNICATION
    y -= 30;
    if (y < 150) {
        page = await addAnnexPage();
        y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page
    }
    
    page.drawText('ANNEX 2:', { x: 60, y, size: 12, font: fonts.helveticaBold, color: black });
    y -= 20;
    page.drawText('ELECTRONICS & COMMUNICATION', { x: 60, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    y -= 25;
    
    if (annexItems['ELECTRONICS & COMMUNICATION'].length === 0) {
        page.drawText('- No electronics selected', { x: 70, y, size: 10, font: fonts.helvetica, color: darkGray });
    } else {
        for (const item of annexItems['ELECTRONICS & COMMUNICATION']) {
            if (y < 100) {
                page = await addAnnexPage();
                y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page
            }
            
            const itemText = `- ${item.name} (Qty: ${item.qty})`;
            page.drawText(truncateText(itemText, 80), { x: 70, y, size: 10, font: fonts.helvetica, color: black });
            y -= 18;
        }
    }
    
    // Footer is already on the template - no need to draw it
}

// ==================== EMBED STATIC PDF ====================
// Standard page size - US Letter (612 x 792)
const STANDARD_PAGE_WIDTH = 612;
const STANDARD_PAGE_HEIGHT = 792;

async function embedStaticPdf(pdfDoc, pdfPath, description) {
    try {
        const url = PDF_CONFIG.baseUrl + pdfPath;
        const response = await fetch(url);
        
        if (!response.ok) {
            console.warn(`Could not load ${description} from ${url}`);
            return;
        }
        
        const pdfBytes = await response.arrayBuffer();
        const externalPdf = await PDFLib.PDFDocument.load(pdfBytes);
        const pages = await pdfDoc.copyPages(externalPdf, externalPdf.getPageIndices());
        
        pages.forEach(page => {
            // Scale page to standard Letter size if different
            const { width, height } = page.getSize();
            if (Math.abs(width - STANDARD_PAGE_WIDTH) > 1 || Math.abs(height - STANDARD_PAGE_HEIGHT) > 1) {
                // Calculate scale to fit content
                const scaleX = STANDARD_PAGE_WIDTH / width;
                const scaleY = STANDARD_PAGE_HEIGHT / height;
                const scale = Math.min(scaleX, scaleY); // Maintain aspect ratio
                
                // Set the page to standard size
                page.setSize(STANDARD_PAGE_WIDTH, STANDARD_PAGE_HEIGHT);
                
                // Scale and center the content
                page.scaleContent(scale, scale);
                
                // Center the content if aspect ratios differ
                if (scaleX !== scaleY) {
                    const newWidth = width * scale;
                    const newHeight = height * scale;
                    const xOffset = (STANDARD_PAGE_WIDTH - newWidth) / 2;
                    const yOffset = (STANDARD_PAGE_HEIGHT - newHeight) / 2;
                    page.translateContent(xOffset, yOffset);
                }
                
                console.log(`Scaled ${description} page from ${width}x${height} to ${STANDARD_PAGE_WIDTH}x${STANDARD_PAGE_HEIGHT}`);
            }
            pdfDoc.addPage(page);
        });
        console.log(`Embedded ${description}: ${pages.length} page(s)`);
    } catch (error) {
        console.warn(`Failed to embed ${description}:`, error);
    }
}

// ==================== FALLBACK SIMPLIFIED PDF ====================
async function generateSimplifiedPDF() {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    
    const formData = gatherFormData();
    const pdfDoc = await PDFDocument.create();
    
    const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
    const timesRoman = await pdfDoc.embedFont(StandardFonts.TimesRoman);
    const timesItalic = await pdfDoc.embedFont(StandardFonts.TimesRomanItalic);
    
    const fonts = { helvetica, helveticaBold, timesRoman, timesItalic };
    
    // Generate only the dynamic pages
    await generateCoverPage(pdfDoc, fonts, formData);
    await generateQuotationPage(pdfDoc, fonts, formData);
    await generateAnnexPages(pdfDoc, fonts, formData);
    
    // Save and download
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${formData.quoteNum}_simplified.pdf`;
    link.click();
    URL.revokeObjectURL(url);
}

// ==================== HELPER FUNCTIONS ====================
function splitTextToLines(text, maxChars) {
    if (!text) return [''];
    const words = text.split(' ');
    const lines = [];
    let currentLine = '';
    
    words.forEach(word => {
        if ((currentLine + ' ' + word).trim().length <= maxChars) {
            currentLine = (currentLine + ' ' + word).trim();
        } else {
            if (currentLine) lines.push(currentLine);
            currentLine = word;
        }
    });
    if (currentLine) lines.push(currentLine);
    return lines.length > 0 ? lines : [''];
}

function truncateText(text, maxChars) {
    if (!text) return '';
    return text.length > maxChars ? text.substring(0, maxChars - 3) + '...' : text;
}

function formatNumber(num) {
    if (typeof num !== 'number') return '0';
    return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function drawDottedLine(page, x1, y1, x2, y2, color) {
    const dotSpacing = 3;
    const distance = x2 - x1;
    const dots = Math.floor(distance / dotSpacing);
    
    for (let i = 0; i < dots; i++) {
        const x = x1 + (i * dotSpacing);
        page.drawCircle({ x, y: y1, size: 0.5, color });
    }
}

// Draw a diamond shape (ASIS logo placeholder)
function drawDiamond(page, x, y, size, color) {
    const half = size / 2;
    // Draw as a rotated square using lines
    page.drawLine({ start: { x: x, y: y + half }, end: { x: x + half, y: y }, thickness: 2, color });
    page.drawLine({ start: { x: x + half, y: y }, end: { x: x, y: y - half }, thickness: 2, color });
    page.drawLine({ start: { x: x, y: y - half }, end: { x: x - half, y: y }, thickness: 2, color });
    page.drawLine({ start: { x: x - half, y: y }, end: { x: x, y: y + half }, thickness: 2, color });
}

// Draw a location pin icon
function drawLocationPin(page, x, y, color) {
    // Simple circle with a point below
    page.drawCircle({ x: x, y: y + 3, size: 4, color, borderWidth: 1.5, borderColor: color });
    page.drawLine({ start: { x: x - 3, y: y + 1 }, end: { x: x, y: y - 5 }, thickness: 1.5, color });
    page.drawLine({ start: { x: x + 3, y: y + 1 }, end: { x: x, y: y - 5 }, thickness: 1.5, color });
}

// Draw a phone icon
function drawPhoneIcon(page, x, y, color) {
    // Simple rectangle for phone body
    page.drawRectangle({ x: x - 3, y: y - 5, width: 6, height: 10, borderColor: color, borderWidth: 1.5 });
    page.drawCircle({ x: x, y: y - 3, size: 1, color });
}

// Draw an envelope icon
function drawEnvelopeIcon(page, x, y, color) {
    // Rectangle body
    page.drawRectangle({ x: x - 5, y: y - 3, width: 10, height: 7, borderColor: color, borderWidth: 1.5 });
    // V shape for flap
    page.drawLine({ start: { x: x - 5, y: y + 4 }, end: { x: x, y: y }, thickness: 1.5, color });
    page.drawLine({ start: { x: x + 5, y: y + 4 }, end: { x: x, y: y }, thickness: 1.5, color });
}

function downloadCSV() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const salesman = document.getElementById('salesman').value;
    
    let csv = 'Description,Quantity,Unit Price,Total\n';
    csv += `"${BOATS[state.boatType].name} - ${boat.size}",${boatQty},${boat.price},${boat.price * boatQty}\n`;
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            // Skip "None" selections (itemIdx === -1)
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                const totalQty = item.qty * boatQty;
                const total = item.isTBD ? 'TBD' : item.price * totalQty;
                const price = item.isTBD ? 'TBD' : item.price;
                csv += `"${item.name}",${totalQty},${price},${total}\n`;
            }
        });
    });
    
    csv += `\nQuote #,${document.getElementById('quoteNum').value}\n`;
    csv += `Date,${document.getElementById('quoteDate').value}\n`;
    csv += `Salesman,${salesman}\n`;
    csv += `Customer,${document.getElementById('custCompany').value}\n`;
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${document.getElementById('quoteNum').value}.csv`;
    a.click();
}

// Init
init();
</script>
</body>
</html>
